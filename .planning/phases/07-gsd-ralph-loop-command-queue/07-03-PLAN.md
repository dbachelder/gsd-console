---
phase: 07-gsd-ralph-loop-command-queue
plan: 03
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified: [src/hooks/useTabState.ts, src/components/layout/TabLayout.tsx, src/app.tsx, src/lib/opencode.ts]
autonomous: true

must_haves:
  truths:
    - "Work Queue tab appears in tab bar as [5] WorkQueue"
    - "Pressing 'w' opens WorkQueue tab when commands are queued"
    - "Pressing 'w' in Roadmap adds current phase command to queue"
    - "Pressing 'w' in Phase tab adds current phase command to queue"
    - "Queue executes via BackgroundJob system when started"
  artifacts:
    - path: "src/hooks/useTabState.ts"
      provides: "Extended TabId type with 'workqueue'"
      exports: ["TabId"]
    - path: "src/components/layout/TabLayout.tsx"
      provides: "WorkQueue tab integration"
      contains: "activeTab === 'workqueue'"
    - path: "src/app.tsx"
      provides: "useWorkQueue hook integration and 'w' key handler"
      contains: "useWorkQueue"
    - path: "src/lib/opencode.ts"
      provides: "Queue execution via BackgroundJob"
      exports: ["executeQueuedCommand"]
  key_links:
    - from: "src/components/layout/TabLayout.tsx"
      to: "src/components/queue/WorkQueueView.tsx"
      via: "import WorkQueueView"
      pattern: "import.*WorkQueueView.*from.*queue"
    - from: "src/app.tsx"
      to: "src/hooks/useWorkQueue.ts"
      via: "useWorkQueue hook"
      pattern: "useWorkQueue.*{"
    - from: "src/app.tsx"
      to: "src/lib/opencode.ts"
      via: "executeQueuedCommand function"
      pattern: "executeQueuedCommand.*{"
---

<objective>
Integrate WorkQueue into TabLayout, add 'w' key intelligent handler, and wire queue execution to BackgroundJob system.

Purpose: Connect queue UI and state to existing app architecture, enable queue management via keyboard shortcuts, and execute queued commands via Phase 4's BackgroundJob engine.
Output: Fully integrated Work Queue tab with intelligent 'w' key behavior and BackgroundJob execution.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gsd-ralph-loop-command-queue/07-CONTEXT.md
@.planning/phases/07-gsd-ralph-loop-command-queue/07-RESEARCH.md
@src/hooks/useTabState.ts
@src/components/layout/TabLayout.tsx
@src/app.tsx
@src/lib/opencode.ts
@src/hooks/useBackgroundJobs.ts
@src/components/queue/WorkQueueView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TabId type and TabLayout for workqueue tab</name>
  <files>src/hooks/useTabState.ts, src/components/layout/TabLayout.tsx</files>
  <action>
    In src/hooks/useTabState.ts:
    1. Add 'workqueue' to TabId type union (line ~9):
       ```typescript
       export type TabId = 'roadmap' | 'phase' | 'todos' | 'background' | 'workqueue';
       ```
    2. Add workqueue to defaultTabState (line ~25):
       ```typescript
       const defaultTabState: Record<TabId, TabState> = {
         roadmap: { expandedPhases: [], selectedIndex: 0, scrollOffset: 0 },
         phase: { selectedPhaseNumber: undefined, detailLevel: 1, scrollOffset: 0 },
         todos: { selectedTodoId: undefined, detailLevel: undefined, scrollOffset: 0 },
         background: { scrollOffset: 0 },
         workqueue: { scrollOffset: 0 },
       };
       ```

    In src/components/layout/TabLayout.tsx:
    1. Add workqueue to tabs import type (line ~10):
       ```typescript
       import { type TabId, useTabState } from '../../hooks/useTabState.ts';
       ```
    2. Add 'workqueue' to useTabNav tabs array (line ~65):
       ```typescript
       const { activeTab, setActiveTab } = useTabNav<TabId>({
         tabs: ['roadmap', 'phase', 'todos', 'background', 'workqueue'],
         ...
       });
       ```
    3. Add WorkQueueView import (line ~14):
       ```typescript
       import { WorkQueueView } from '../queue/WorkQueueView.tsx';
       ```
    4. Add WorkQueueView props to TabLayoutProps interface (line ~36):
       ```typescript
       /** Work Queue state */
       workQueue?: QueuedCommand[];
       /** Callback to remove command from queue */
       onQueueRemove?: (id: string) => void;
       ```
    5. Add 'workqueue' to TabBar tabs array (line ~221):
       ```typescript
       const tabs: { id: TabId; label: string; key: string }[] = [
         { id: 'roadmap', label: 'Roadmap', key: '1' },
         { id: 'phase', label: 'Phase', key: '2' },
         { id: 'todos', label: 'Todos', key: '3' },
         { id: 'background', label: 'Background', key: '4' },
         { id: 'workqueue', label: 'WorkQueue', key: '5' },
       ];
       ```
    6. Destructure workQueue and onQueueRemove from props (line ~39):
       ```typescript
       workQueue = [],
       onQueueRemove,
       ```
    7. Add WorkQueueView render block in active view content (line ~211):
       ```typescript
       {activeTab === 'workqueue' && (
         <WorkQueueView
           queue={workQueue}
           isActive={isActive}
           onQueueRemove={onQueueRemove ?? (() => {})}
           showToast={showToast}
         />
       )}
       ```

    Follow existing TabLayout patterns for consistency.
  </action>
  <verify>grep "'workqueue'" src/hooks/useTabState.ts && grep "activeTab === 'workqueue'" src/components/layout/TabLayout.tsx</verify>
  <done>TabLayout updated with workqueue tab and WorkQueueView integration</done>
</task>

<task type="auto">
  <name>Task 2: Add useWorkQueue hook integration to App and executeQueuedCommand</name>
  <files>src/app.tsx, src/lib/opencode.ts</files>
  <action>
    In src/lib/opencode.ts:
    Add executeQueuedCommand function after createSession (around line ~50):
    ```typescript
    /**
     * Execute a queued command via BackgroundJob system.
     * Queues command in useBackgroundJobs for headless execution.
     */
    export async function executeQueuedCommand(
      command: string,
      args?: string,
      sessionId?: string,
      addBackgroundJob?: (cmd: string) => void
    ): Promise<boolean> {
      if (!addBackgroundJob) {
        return false;
      }

      const fullCommand = args ? `${command} ${args}` : command;
      const formattedCommand = formatGsdCommand(fullCommand, 'opencode');

      // Add to BackgroundJob queue (reuses Phase 4 execution engine)
      addBackgroundJob(formattedCommand, sessionId);

      return true;
    }
    ```

    In src/app.tsx:
    1. Add useWorkQueue import (line ~18):
       ```typescript
       import { useWorkQueue } from './hooks/useWorkQueue.ts';
       ```
    2. Add executeQueuedCommand import from opencode (line ~33):
       ```typescript
       import {
         createSession,
         executeQueuedCommand,
         formatGsdCommand,
         ...
       } from './lib/opencode.ts';
       ```
    3. Initialize useWorkQueue hook (line ~167):
       ```typescript
       // Work Queue (user-managed GSD command queue)
       const workQueue = useWorkQueue();
       ```
    4. Update TabLayout props to pass workQueue state (line ~354):
       ```typescript
       <TabLayout
         ...
         backgroundJobs={backgroundJobs}
         onCancelJob={cancelBackgroundJob}
         workQueue={workQueue.queue}
         onQueueRemove={workQueue.remove}
       />
       ```
    5. Update activeTab state type to include 'workqueue' (line ~124):
       ```typescript
       const [activeTab, setActiveTab] = useState<'roadmap' | 'phase' | 'todos' | 'background' | 'workqueue'>(
         flags.only ?? 'roadmap',
       );
       ```

    Reuse BackgroundJob execution engine per RESEARCH.md recommendation.
  </action>
  <verify>grep "executeQueuedCommand" src/lib/opencode.ts && grep "useWorkQueue" src/app.tsx</verify>
  <done>useWorkQueue hook integrated in App, executeQueuedCommand added to opencode</done>
</task>

<task type="auto">
  <name>Task 3: Add 'w' key intelligent handler in App</name>
  <files>src/app.tsx</files>
  <action>
    Add 'w' key handler to useInput block (line ~305):

    ```typescript
    if (input === 'w') {
      // Intelligent 'w' key behavior based on phase state
      if (workQueue.queue.length > 0) {
        // Open WorkQueue tab if commands are queued
        setActiveTab('workqueue');
        showToast(`WorkQueue: ${workQueue.queue.length} commands`, 'info');
      } else if (activeTab === 'roadmap' && selectedPhaseNumber) {
        // In Roadmap: add plan-phase command for current phase
        const command = 'plan-phase';
        const args = String(selectedPhaseNumber);
        workQueue.add(command, args);
        showToast(`Added: ${command} ${args}`, 'success');
        setActiveTab('workqueue');
      } else if (activeTab === 'phase' && selectedPhaseNumber) {
        // In Phase: add plan-phase command for current phase
        const command = 'plan-phase';
        const args = String(selectedPhaseNumber);
        workQueue.add(command, args);
        showToast(`Added: ${command} ${args}`, 'success');
        setActiveTab('workqueue');
      } else {
        showToast('No phase selected or queue empty', 'warning');
      }
    }
    ```

    Implement intelligent behavior per CONTEXT.md:
    - Open WorkQueue tab when commands are queued
    - Add plan-phase command in Roadmap/Phase tabs
    - Switch to WorkQueue tab after adding command

    Add 'w: WorkQueue' hint to Footer component (verify Footer.tsx exists and has commonHints).
  </action>
  <verify>grep "input === 'w'" src/app.tsx && grep "setActiveTab('workqueue')" src/app.tsx</verify>
  <done>'w' key intelligently opens WorkQueue tab or adds phase command to queue</done>
</task>

</tasks>

<verification>
- TabLayout renders WorkQueueView when activeTab === 'workqueue'
- TabBar shows [5] WorkQueue tab
- useWorkQueue hook initialized in App
- 'w' key opens WorkQueue tab when queue has commands
- 'w' key adds plan-phase command when in Roadmap/Phase tab
- 'w' key switches to WorkQueue tab after adding command
- executeQueuedCommand uses addBackgroundJob for execution
</verification>

<success_criteria>
- WorkQueue tab accessible via [5] or 'w' key
- 'w' key behavior matches intelligent logic
- Queue state managed by useWorkQueue hook
- Queue removal wired in TabLayout
</success_criteria>

<output>
After completion, create `.planning/phases/07-gsd-ralph-loop-command-queue/07-03-SUMMARY.md`
</output>
