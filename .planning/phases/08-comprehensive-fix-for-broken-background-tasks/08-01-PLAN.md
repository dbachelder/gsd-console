---
phase: 08-comprehensive-fix-for-broken-background-tasks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/hooks/useBackgroundJobs.ts, src/app.tsx]
autonomous: true

must_haves:
  truths:
    - "Headless jobs create new sessions and execute commands successfully"
    - "Background jobs transition from pending → running → complete without getting stuck"
    - "Jobs execute sequentially, one at a time"
  artifacts:
    - path: "src/hooks/useBackgroundJobs.ts"
      provides: "Background job queue with proper session readiness detection"
      contains: "handleIdle"
    - path: "src/app.tsx"
      provides: "Headless mode creates sessions and adds jobs without premature handleIdle trigger"
      contains: "createSession"
  key_links:
    - from: "src/app.tsx (handleModeSelect, headless case)"
      to: "src/hooks/useBackgroundJobs.ts (add)"
      via: "addBackgroundJob(formattedCommand, newSessionId) - no handleIdle trigger"
      pattern: "addBackgroundJob.*newSessionId"
    - from: "src/hooks/useBackgroundJobs.ts (useSessionEvents)"
      to: "src/hooks/useBackgroundJobs.ts (handleIdle)"
      via: "Session idle event from new session triggers job processing"
      pattern: "onIdle.*handleIdle"
---

<objective>
Fix background jobs stuck in pending state by removing premature handleIdle trigger from new sessions

Purpose: Currently, when headless mode creates a new session via createSession(), the code immediately calls handleIdle(jobSessionId) in the add() function. However, the new session may not be in an idle state yet (it could still be initializing), so handleIdle doesn't trigger job execution. Jobs remain stuck in 'pending' state. The session.idle event that arrives later will properly trigger handleIdle, but by then the premature call has already been made. The fix is to remove the premature handleIdle call and rely solely on session idle events.

Output: Background jobs execute reliably using session idle events as the trigger, not premature polling
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-comprehensive-fix-for-broken-background-tasks/08-CONTEXT.md
@src/app.tsx
@src/hooks/useBackgroundJobs.ts
@src/lib/opencode.ts
</context>

<tasks>

<task type="auto">
  <name>Remove premature handleIdle trigger from useBackgroundJobs.add()</name>
  <files>src/hooks/useBackgroundJobs.ts</files>
  <action>
  Fix the useBackgroundJobs hook to wait for session idle events instead of triggering prematurely:

  1. In the add() function (lines 225-247), remove the conditional that calls handleIdle(jobSessionId) at lines 241-243:
     ```typescript
     // REMOVE THIS BLOCK:
     if (jobSessionId && !isProcessing) {
       // Trigger idle check - if session is already idle, this will start job
       handleIdle(jobSessionId);
     }
     ```

  2. After removing this block, jobs will wait for the natural session.idle event to trigger processing. The session.idle event fires when the session is ready to accept prompts, ensuring that handleIdle() is called at the right time.

  3. The add() function should end after calling showToast() and setJobs(), without any immediate handleIdle trigger.

  Reference existing code: Lines 236-243 contain the premature trigger to remove.
  </action>
  <verify>TypeScript compiles: bun run typecheck</verify>
  <done>useBackgroundJobs.add() no longer calls handleIdle() prematurely; jobs wait for session.idle event to start</done>
</task>

<task type="auto">
  <name>Verify headless execution flow in app.tsx</name>
  <files>src/app.tsx</files>
  <action>
  Review the headless mode implementation in handleModeSelect() to ensure it doesn't have any premature trigger logic:

  1. In headless case (lines 211-224), verify the flow:
     - createSession() is called and returns newSessionId
     - If successful, addBackgroundJob(formattedCommand, newSessionId) is called
     - No other logic that might interfere with job processing

  2. Ensure the code doesn't call any functions that might trigger job execution before the session is idle. The job should be added to the queue and wait for the session.idle event to start processing.

  3. Confirm that error handling (showToast) is still in place for failed session creation.

  Reference existing code: Lines 211-224 (headless case).

  Note: No changes should be needed here if the fix in Task 1 is correct. This task is for verification/documentation.
  </action>
  <verify>TypeScript compiles: bun run typecheck</verify>
  <done>app.tsx headless flow verified to add jobs without premature execution triggers</done>
</task>

<task type="auto">
  <name>Add GLM4.7 default model configuration</name>
  <files>README.md, CLAUDE.md</files>
  <action>
  Document GLM4.7 as the default model for OpenCode background tasks:

  1. Update README.md to include a section on configuring OpenCode default model:
     - Explain that background jobs use OpenCode's default model setting
     - Document how to set defaultModel to 'glm-4.7' in ~/.opencode/opencode.json

  2. Update CLAUDE.md to mention GLM4.7 as the recommended model for background GSD commands:
     - Add to project overview or dependencies section
     - Note that this is a server-side OpenCode configuration, not controlled by the TUI

  3. The key point: GLM4.7 is set in OpenCode's opencode.json configuration file, not in the TUI codebase. The TUI just uses whatever model OpenCode defaults to.

  This is a documentation task - no code changes to the TUI itself.
  </action>
  <verify>README.md and CLAUDE.md contain GLM4.7 model configuration instructions</verify>
  <done>Documentation updated to reflect GLM4.7 as default model for background tasks</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: bun run typecheck
2. Linter passes: bun run lint
3. Manual test: Run TUI, execute headless command, verify job transitions pending → running → complete without getting stuck
4. Manual test: Execute multiple headless commands sequentially, verify they process one at a time
</verification>

<success_criteria>
- Headless background jobs execute without getting stuck in pending state
- Jobs transition through pending → running → complete states correctly
- Sequential job processing works (one job at a time)
- GLM4.7 configuration is documented for users
- No premature handleIdle triggers that could cause race conditions
</success_criteria>

<output>
After completion, create .planning/phases/08-comprehensive-fix-for-broken-background-tasks/08-01-SUMMARY.md
</output>
