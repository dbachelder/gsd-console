---
phase: 08-comprehensive-fix-for-broken-background-tasks
plan: 02
type: execute
wave: 1
depends_on: [01]
files_modified: [src/hooks/useBackgroundJobs.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Jobs transition from pending → running → complete without getting stuck"
    - "Jobs execute sequentially, one at a time"
    - "Newly created sessions immediately start processing pending jobs"
  artifacts:
    - path: "src/hooks/useBackgroundJobs.ts"
      provides: "Proactive job startup for idle sessions"
      contains: "useEffect.*checkAndStartPendingJobs"
  key_links:
    - from: "src/hooks/useBackgroundJobs.ts"
      to: "sendPrompt"
      via: "Proactive check in useEffect"
      pattern: "useEffect.*startPendingJob"
---

<objective>
Fix background jobs stuck in pending state by adding proactive job startup when jobs are added for newly created sessions.

Purpose: Ensure jobs execute immediately for sessions that are already idle, instead of waiting for session.idle events that never fire for newly created sessions.
Output: Background jobs that transition from pending → running → complete reliably for both existing and newly created sessions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-comprehensive-fix-for-broken-background-tasks/08-UAT.md
@.planning/phases/08-comprehensive-fix-for-broken-background-tasks/08-01-SUMMARY.md

# Root cause from UAT.md
"Newly created OpenCode sessions never emit session.idle events because they start in idle state. Job processing system waits for idle events that never fire."

# Current implementation
- useBackgroundJobs.add() creates pending jobs but doesn't trigger job startup
- useSessionEvents only calls handleIdle when session.idle event fires
- handleIdle starts pending jobs when session goes idle
- Newly created sessions are already idle, so event never fires, jobs never start
</context>

<tasks>

<task type="auto">
  <name>Add proactive job startup for idle sessions</name>
  <files>src/hooks/useBackgroundJobs.ts</files>
  <action>
Add a useEffect in useBackgroundJobs that proactively checks for pending jobs and starts them when:
1. A new job is added to the queue
2. No job is currently running
3. The job's session exists

Implementation:
1. Create a new function `startPendingJob()` that:
   - Finds the first pending job
   - If job.sessionId exists and no other job is running for that session, calls sendPrompt
   - Only marks job as running after sendPrompt succeeds (not before)

2. Add useEffect that:
   - Runs whenever jobs array changes
   - Checks if there are pending jobs but no running jobs
   - Calls startPendingJob() to proactively start the next job

3. Mark jobs as running AFTER sendPromise succeeds:
   - Current code marks as running before sendPrompt (line 145-154 in current file)
   - Move status='running' update inside the sendPrompt.then() success case
   - This ensures failed sendPrompt doesn't leave jobs stuck in running state

Reference existing handleIdle logic for the job starting pattern (lines 107-155 in current file), but trigger it proactively instead of waiting for session.idle event.
</action>
  <verify>
Run TUI, execute a headless GSD command, verify job transitions: pending → running → complete within seconds (not stuck pending).
</verify>
  <done>Jobs transition from pending to running immediately when added for idle sessions, without waiting for session.idle events.</done>
</task>

<task type="auto">
  <name>Verify sequential job processing works</name>
  <files>src/hooks/useBackgroundJobs.ts</files>
  <action>
Test that multiple queued jobs process sequentially:
1. Queue multiple headless commands rapidly
2. Verify only one job runs at a time
3. Verify second job starts only after first completes (via session.idle event or proactive check)

The proactive startup effect combined with existing session.idle event handling should provide both:
- Immediate startup for first job (new idle session)
- Sequential processing for subsequent jobs (session.idle event fires after first completes)

No code changes needed if useEffect properly checks "no running job" before starting new job.
</action>
  <verify>
Queue 3 headless commands: /gsd-add-todo test1, /gsd-add-todo test2, /gsd-add-todo test3. Verify in Background tab: jobs execute one at a time, each completes before next starts.
</verify>
  <done>Multiple jobs queue up and execute sequentially, one at a time, without getting stuck.</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Gap closure fixes for background jobs stuck in pending state</what-built>
  <how-to-verify>
1. Start TUI with opencode serve running: GSD_DEBUG=1 bun run dev
2. Press `:` to open command palette
3. Execute a headless GSD command: /gsd-add-todo "test background job"
4. Press `Tab` to switch to Background view
5. Verify job status transitions: pending → running → complete (within 2-3 seconds, not stuck)
6. Repeat with 3-4 commands in quick succession
7. Verify all jobs process sequentially without getting stuck
8. Check debug log: tail -f /tmp/gsd-tui-debug.log (should show "Sending prompt body" logs)
</how-to-verify>
  <resume-signal>Type "approved" if jobs transition correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After gap closure, verify:
1. [ ] Jobs transition from pending → running → complete for newly created sessions
2. [ ] Jobs don't get stuck in pending state
3. [ ] Multiple jobs process sequentially, one at a time
4. [ ] No jobs stuck in running state after failed sendPrompt
5. [ ] Existing session.idle event handling still works (for already-running sessions)
</verification>

<success_criteria>
All UAT gaps resolved:
- Jobs transition from pending → running → complete without getting stuck
- Jobs execute sequentially, one at a time
- Newly created sessions immediately start processing pending jobs
</success_criteria>

<output>
After completion, create `.planning/phases/08-comprehensive-fix-for-broken-background-tasks/08-02-SUMMARY.md`
</output>
