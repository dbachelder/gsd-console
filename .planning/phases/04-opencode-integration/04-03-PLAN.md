---
phase: 04-opencode-integration
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/hooks/useOpencodeConnection.ts
  - src/lib/opencode.ts
  - src/components/picker/SessionPicker.tsx
  - src/lib/commands.ts
autonomous: true

must_haves:
  truths:
    - "User can see list of available OpenCode sessions"
    - "Sessions are filtered to current project directory"
    - "User can select a session to connect"
    - "Selected session becomes the active session for command queueing"
    - "Command palette shows connect-session command"
  artifacts:
    - path: "src/lib/opencode.ts"
      provides: "Session listing and filtering functions"
      exports: ["listSessions", "getProjectSessions"]
    - path: "src/components/picker/SessionPicker.tsx"
      provides: "UI for session selection"
      exports: ["SessionPicker"]
    - path: "src/lib/commands.ts"
      provides: "connect-session command"
      contains: "connect-session"
  key_links:
    - from: "src/components/picker/SessionPicker.tsx"
      to: "src/lib/opencode.ts"
      via: "listSessions call"
      pattern: "listSessions|getProjectSessions"
    - from: "src/lib/commands.ts"
      to: "SessionPicker"
      via: "triggers picker display"
      pattern: "connect-session"
    - from: "SessionPicker.onSelect"
      to: "App.activeSessionId"
      via: "callback sets state"
      pattern: "setActiveSessionId"
---

<objective>
Enable connecting to existing OpenCode sessions from the TUI.

Purpose: Allow users to attach to running sessions instead of always spawning new ones (part of ACT-04).
Output: Session picker UI and connect-session command that establishes a usable connection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-opencode-integration/04-RESEARCH.md
@.planning/phases/04-opencode-integration/04-01-SUMMARY.md

@src/lib/opencode.ts
@src/lib/commands.ts
@src/components/picker/FilePicker.tsx
@src/app.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session listing functions</name>
  <files>src/lib/opencode.ts</files>
  <action>
    Add to `src/lib/opencode.ts`:

    1. Type for session info (minimal, from SDK):
    ```typescript
    /** Simplified session info for display */
    export interface SessionInfo {
      id: string;
      title?: string;
      projectId?: string;
      createdAt?: string;
    }
    ```

    2. `listSessions()` - List all available sessions:
    ```typescript
    /**
     * List all OpenCode sessions.
     * Returns empty array if server not available.
     */
    export async function listSessions(): Promise<SessionInfo[]> {
      try {
        const client = createClient();
        const response = await client.session.list();
        return (response.data ?? []).map(s => ({
          id: s.id,
          title: s.title,
          projectId: s.info?.projectID,
          createdAt: s.createdAt,
        }));
      } catch {
        return [];
      }
    }
    ```

    3. `getProjectSessions(projectDir: string)` - Filter to current project:
    ```typescript
    /**
     * Get sessions for a specific project directory.
     * Filters by projectId containing the directory path.
     */
    export async function getProjectSessions(projectDir: string): Promise<SessionInfo[]> {
      const sessions = await listSessions();
      return sessions.filter(s => s.projectId?.includes(projectDir));
    }
    ```

    Handle all errors gracefully - return empty array on failure.
  </action>
  <verify>
    1. `bun run typecheck` passes
    2. Functions are exported
    3. `bun run lint` passes
  </verify>
  <done>
    - SessionInfo type defined
    - listSessions returns all sessions
    - getProjectSessions filters by project directory
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SessionPicker component</name>
  <files>src/components/picker/SessionPicker.tsx</files>
  <action>
    Create `src/components/picker/SessionPicker.tsx` based on FilePicker.tsx pattern:

    ```typescript
    /**
     * Session Picker Component
     * Allows user to select from available OpenCode sessions.
     */
    ```

    Props:
    - sessions: SessionInfo[]
    - onSelect: (sessionId: string) => void
    - onClose: () => void
    - isLoading?: boolean

    Features:
    1. Box with border, background='black' (same as FilePicker)
    2. Title: "Select Session"
    3. List sessions with:
       - Title (or "Untitled" if none)
       - Truncated session ID
       - Project indicator if matches current project
    4. Vim navigation (j/k or arrows)
    5. Enter to select, Escape to close
    6. Empty state: "No sessions available"
    7. Loading state: Show spinner

    Use useVimNav hook for navigation (same as FilePicker).

    Key bindings (when isActive):
    - Enter: call onSelect with selected session ID
    - Escape: call onClose

    Display format per session:
    ```
    > Session Title (abc123...)
      Another Session (def456...)
    ```

    Use dimColor for session ID, bold for selected.
  </action>
  <verify>
    1. Component exists at src/components/picker/SessionPicker.tsx
    2. `bun run typecheck` passes
    3. `bun run lint` passes
  </verify>
  <done>
    - SessionPicker component renders session list
    - Keyboard navigation works
    - Enter selects, Escape closes
    - Handles empty and loading states
  </done>
</task>

<task type="auto">
  <name>Task 3: Add connect-session command and wire to App state</name>
  <files>src/lib/commands.ts, src/app.tsx</files>
  <action>
    1. Update `src/lib/commands.ts`:
       - Add connect-session command (stub for now - actual picker trigger is in App):
       ```typescript
       {
         name: 'connect-session',
         description: 'Connect to existing OpenCode session',
         action: createStubAction('connect-session'),
       },
       ```

    2. Update `src/app.tsx` to integrate SessionPicker with REAL connection:
       - Import SessionPicker and session functions
       - Add state for activeSessionId: string | undefined
       - Add state for showSessionPicker: boolean
       - Add state for sessions: SessionInfo[]
       - Add state for sessionsLoading: boolean

       Add keyboard shortcut 'c' that opens the session picker:
       ```typescript
       if (input === 'c') {
         // Load sessions and show picker
         setSessionsLoading(true);
         getProjectSessions(process.cwd()).then(s => {
           setSessions(s);
           setSessionsLoading(false);
           if (s.length === 0) {
             showToast('No OpenCode sessions found', 'warning');
           } else {
             setShowSessionPicker(true);
           }
         });
       }
       ```

       Render SessionPicker when showSessionPicker is true.

       **CRITICAL: Wire onSelect to establish real connection:**
       ```tsx
       {showSessionPicker && (
         <Box position="absolute" marginTop={3} marginLeft={2}>
           <SessionPicker
             sessions={sessions}
             isLoading={sessionsLoading}
             onSelect={(sessionId) => {
               setShowSessionPicker(false);
               // ACTUALLY SET THE ACTIVE SESSION - this is the key wiring
               setActiveSessionId(sessionId);
               showToast(`Connected to session: ${sessionId.slice(0, 8)}...`, 'success');
             }}
             onClose={() => setShowSessionPicker(false)}
           />
         </Box>
       )}
       ```

       This is the critical link: SessionPicker.onSelect -> setActiveSessionId.
       Plan 05 will use activeSessionId for command queue integration.

       Update isActive checks to include !showSessionPicker.
  </action>
  <verify>
    1. `bun run typecheck` passes
    2. `bun run lint` passes
    3. 'c' key opens session picker (when no server, shows warning)
    4. Selecting a session sets activeSessionId state (not just toast)
  </verify>
  <done>
    - connect-session command exists
    - 'c' key triggers session picker
    - Session picker displays and closes correctly
    - **onSelect sets activeSessionId (real connection established)**
    - Empty state handled with toast
  </done>
</task>

</tasks>

<verification>
```bash
bun run typecheck && bun run lint
bun start
# Press 'c' to open session picker
# Should show "No OpenCode sessions found" if no server
# Or show session list if server running with sessions
# Selecting a session should set activeSessionId (verify via console.log or behavior)
```
</verification>

<success_criteria>
1. Session listing functions work (return empty array gracefully)
2. SessionPicker component renders correctly
3. 'c' key opens session picker
4. Empty state shows toast warning
5. **Selecting a session sets activeSessionId state (usable connection)**
6. All type/lint checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-opencode-integration/04-03-SUMMARY.md`
</output>
