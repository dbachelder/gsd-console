---
phase: 04-opencode-integration
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/hooks/useOpencodeConnection.ts
  - src/lib/opencode.ts
  - src/components/picker/SessionPicker.tsx
  - src/lib/commands.ts
  - src/app.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of available OpenCode sessions"
    - "Sessions display ID, directory, and last command"
    - "Sessions filtered to directories containing .planning/"
    - "When no sessions exist, user is offered to spawn a new one"
    - "User can select a session to connect"
    - "Selected session becomes the active session for command execution"
  artifacts:
    - path: "src/lib/opencode.ts"
      provides: "Session listing and filtering functions"
      exports: ["listSessions", "getProjectSessions"]
    - path: "src/components/picker/SessionPicker.tsx"
      provides: "UI for session selection with spawn option"
      exports: ["SessionPicker"]
    - path: "src/lib/commands.ts"
      provides: "connect-session command"
      contains: "connect-session"
  key_links:
    - from: "src/components/picker/SessionPicker.tsx"
      to: "src/lib/opencode.ts"
      via: "listSessions call"
      pattern: "listSessions|getProjectSessions"
    - from: "src/lib/commands.ts"
      to: "SessionPicker"
      via: "triggers picker display"
      pattern: "connect-session"
    - from: "SessionPicker.onSelect"
      to: "App.activeSessionId"
      via: "callback sets state"
      pattern: "setActiveSessionId"
    - from: "SessionPicker.onSpawnNew"
      to: "spawnOpencodeSession"
      via: "callback spawns new session"
      pattern: "spawnOpencodeSession"
---

<objective>
Enable connecting to existing OpenCode sessions from the TUI.

Purpose: Allow users to attach to running sessions instead of always spawning new ones (part of ACT-04).
Output: Session picker UI showing ID + directory + last command, with option to spawn if none exist.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-opencode-integration/04-RESEARCH.md
@.planning/phases/04-opencode-integration/04-CONTEXT.md
@.planning/phases/04-opencode-integration/04-01-SUMMARY.md

@src/lib/opencode.ts
@src/lib/commands.ts
@src/components/picker/FilePicker.tsx
@src/app.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session listing functions with enhanced info</name>
  <files>src/lib/opencode.ts</files>
  <action>
    Add to `src/lib/opencode.ts`:

    1. Type for session info (per CONTEXT.md: ID, directory, last command):
    ```typescript
    /** Session info for display in picker */
    export interface SessionInfo {
      id: string;
      directory?: string;       // Project directory
      lastCommand?: string;     // Last prompt/command run
      createdAt?: string;
    }
    ```

    2. `listSessions()` - List all available sessions:
    ```typescript
    /**
     * List all OpenCode sessions.
     * Returns empty array if server not available.
     */
    export async function listSessions(): Promise<SessionInfo[]> {
      try {
        const client = createClient();
        const response = await client.session.list();
        return (response.data ?? []).map(s => ({
          id: s.id,
          directory: s.info?.projectID,  // OpenCode stores path in projectID
          lastCommand: s.messages?.slice(-1)[0]?.text,  // Last message as command hint
          createdAt: s.createdAt,
        }));
      } catch {
        return [];
      }
    }
    ```

    3. `getProjectSessions(projectDir: string)` - Filter to projects with .planning/:
    ```typescript
    /**
     * Get sessions for directories containing .planning/.
     * Per CONTEXT.md: Filter to sessions in directory tree containing .planning/
     */
    export async function getProjectSessions(projectDir: string): Promise<SessionInfo[]> {
      const sessions = await listSessions();
      // Filter to sessions whose directory starts with or equals projectDir
      // This catches subdirectories of the current project
      return sessions.filter(s => {
        if (!s.directory) return false;
        // Session is in the same directory tree as our project
        return s.directory.startsWith(projectDir) || projectDir.startsWith(s.directory);
      });
    }
    ```

    Handle all errors gracefully - return empty array on failure.
  </action>
  <verify>
    1. `bun run typecheck` passes
    2. Functions are exported
    3. `bun run lint` passes
  </verify>
  <done>
    - SessionInfo type includes id, directory, lastCommand
    - listSessions returns all sessions with enhanced info
    - getProjectSessions filters by .planning/ directory tree
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SessionPicker component with spawn option</name>
  <files>src/components/picker/SessionPicker.tsx</files>
  <action>
    Create `src/components/picker/SessionPicker.tsx` based on FilePicker.tsx pattern:

    ```typescript
    /**
     * Session Picker Component
     * Allows user to select from available OpenCode sessions.
     * Per CONTEXT.md: Shows ID + directory + last command, offers spawn if none.
     */
    ```

    Props:
    - sessions: SessionInfo[]
    - onSelect: (sessionId: string) => void
    - onSpawnNew: () => void           // NEW: callback when user wants to spawn
    - onClose: () => void
    - isLoading?: boolean

    Features:
    1. Box with border, background='black' (same as FilePicker)
    2. Title: "Select Session"
    3. Display format per session (per CONTEXT.md - ID, directory, last command):
       ```
       > abc123... ~/src/myproject
         "plan-phase 3"

         def456... ~/src/other
         "execute-phase 2"
       ```
       - First line: truncated ID (8 chars) + directory
       - Second line (dimColor, indented): last command in quotes (truncate to 40 chars)
    4. Vim navigation (j/k or arrows)
    5. Enter to select, Escape to close
    6. **Empty state (per CONTEXT.md: offer to spawn):**
       ```
       No OpenCode sessions found.

       Press Enter to spawn a new session
       Press Escape to cancel
       ```
       When Enter pressed in empty state -> call onSpawnNew()
    7. Loading state: Show spinner

    Use useVimNav hook for navigation (same as FilePicker).

    Key bindings (when isActive):
    - Enter: call onSelect with selected session ID (or onSpawnNew if empty)
    - Escape: call onClose

    Use dimColor for secondary info, bold for selected.
  </action>
  <verify>
    1. Component exists at src/components/picker/SessionPicker.tsx
    2. `bun run typecheck` passes
    3. `bun run lint` passes
  </verify>
  <done>
    - SessionPicker displays ID + directory + last command
    - Keyboard navigation works
    - Enter selects, Escape closes
    - Empty state offers to spawn new session
    - Handles loading state
  </done>
</task>

<task type="auto">
  <name>Task 3: Add connect-session command and wire to App state</name>
  <files>src/lib/commands.ts, src/app.tsx</files>
  <action>
    1. Update `src/lib/commands.ts`:
       - Add connect-session command (stub for now - actual picker trigger is in App):
       ```typescript
       {
         name: 'connect-session',
         description: 'Connect to existing OpenCode session',
         action: createStubAction('connect-session'),
       },
       ```

    2. Update `src/app.tsx` to integrate SessionPicker:
       - Import SessionPicker, session functions, and spawnOpencodeSession
       - Add state for activeSessionId: string | undefined
       - Add state for showSessionPicker: boolean
       - Add state for sessions: SessionInfo[]
       - Add state for sessionsLoading: boolean

       Add keyboard shortcut 'c' that opens the session picker:
       ```typescript
       if (input === 'c') {
         // Load sessions and show picker
         setSessionsLoading(true);
         setShowSessionPicker(true);
         getProjectSessions(process.cwd()).then(s => {
           setSessions(s);
           setSessionsLoading(false);
           // Don't show warning here - picker handles empty state
         });
       }
       ```

       Render SessionPicker when showSessionPicker is true.

       **CRITICAL: Wire callbacks per CONTEXT.md:**
       ```tsx
       {showSessionPicker && (
         <Box position="absolute" marginTop={3} marginLeft={2}>
           <SessionPicker
             sessions={sessions}
             isLoading={sessionsLoading}
             onSelect={(sessionId) => {
               setShowSessionPicker(false);
               setActiveSessionId(sessionId);
               showToast(`Connected to session: ${sessionId.slice(0, 8)}...`, 'success');
             }}
             onSpawnNew={() => {
               // Per CONTEXT.md: offer to spawn when no sessions
               setShowSessionPicker(false);
               const success = spawnOpencodeSession();
               if (success) {
                 showToast('OpenCode session completed', 'success');
               } else {
                 showToast('OpenCode session failed or was cancelled', 'warning');
               }
             }}
             onClose={() => setShowSessionPicker(false)}
           />
         </Box>
       )}
       ```

       Update isActive checks to include !showSessionPicker.
  </action>
  <verify>
    1. `bun run typecheck` passes
    2. `bun run lint` passes
    3. 'c' key opens session picker
    4. Selecting a session sets activeSessionId state
    5. Empty state Enter spawns new session
  </verify>
  <done>
    - connect-session command exists
    - 'c' key triggers session picker
    - Session picker displays ID + directory + last command
    - Selecting a session sets activeSessionId
    - Empty state offers to spawn new session via onSpawnNew
  </done>
</task>

</tasks>

<verification>
```bash
bun run typecheck && bun run lint
bun start
# Press 'c' to open session picker
# Should show sessions with ID + directory + last command format
# Or show "No sessions" with spawn option if no server
```
</verification>

<success_criteria>
1. Session listing functions return ID, directory, lastCommand
2. SessionPicker displays sessions with new format
3. Empty state offers to spawn new session
4. 'c' key opens session picker
5. Selecting a session sets activeSessionId state
6. All type/lint checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-opencode-integration/04-03-SUMMARY.md`
</output>
