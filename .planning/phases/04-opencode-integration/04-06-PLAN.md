---
phase: 04-opencode-integration
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/layout/Footer.tsx
  - src/lib/opencode.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Footer displays 'c' key hint for connecting to sessions"
    - "Session picker shows sessions when OpenCode session is running"
  artifacts:
    - path: "src/components/layout/Footer.tsx"
      provides: "Connect hint in footer"
      contains: "connect"
    - path: "src/lib/opencode.ts"
      provides: "Fixed session detection"
      exports: ["getProjectSessions"]
  key_links:
    - from: "Footer.tsx"
      to: "App.tsx 'c' key handler"
      via: "User sees hint and presses c"
    - from: "getProjectSessions"
      to: "SessionPicker"
      via: "Sessions array passed as prop"
---

<objective>
Fix session detection and add missing 'c' connect hint to footer.

Purpose: Close two UAT gaps - users should see the 'c' key in footer hints, and session detection should find running OpenCode sessions.

Output: Footer shows connect hint; session picker finds sessions correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

@src/components/layout/Footer.tsx
@src/lib/opencode.ts
@src/app.tsx (lines 263-271 for 'c' key handler)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 'c' connect hint to Footer</name>
  <files>src/components/layout/Footer.tsx</files>
  <action>
Add a connect hint to commonHints array:
```typescript
const commonHints: Hint[] = [
  { key: 'c', action: 'connect' },  // Add this before other hints
  { key: ':', action: 'commands' },
  { key: '?', action: 'help' },
  { key: 'q', action: 'quit' },
];
```

This makes 'c' visible in footer at all times since it's a global action (like 'q' for quit).
  </action>
  <verify>Run `bun run typecheck` and visually confirm footer shows 'c: connect' hint.</verify>
  <done>Footer displays 'c: connect' hint alongside other common hints.</done>
</task>

<task type="auto">
  <name>Task 2: Debug and fix session detection</name>
  <files>src/lib/opencode.ts</files>
  <action>
The issue is in `getProjectSessions`. First, add debug logging to understand the problem:

1. Add temporary console.log in getProjectSessions to see:
   - What `listSessions()` returns (raw session data)
   - What `projectDir` value is being compared
   - What each `s.directory` value is

2. Run TUI with `bun run dev`, open a separate terminal with `opencode` running, press 'c' to see debug output.

3. Likely issues to fix:
   - **Trailing slash mismatch**: `projectDir` might be `/path/to/project` while session.directory is `/path/to/project/`
   - **Undefined directory**: Some sessions might not have directory set
   - **Case sensitivity**: On macOS, paths could have case mismatches

Fix the comparison logic:
```typescript
export async function getProjectSessions(projectDir: string): Promise<SessionInfo[]> {
  const sessions = await listSessions();

  // Normalize paths: remove trailing slashes for consistent comparison
  const normalizedProjectDir = projectDir.replace(/\/+$/, '');

  return sessions.filter((s) => {
    if (!s.directory) return false;
    const normalizedSessionDir = s.directory.replace(/\/+$/, '');

    // Session is in project tree OR project is in session tree
    return (
      normalizedSessionDir.startsWith(normalizedProjectDir) ||
      normalizedProjectDir.startsWith(normalizedSessionDir)
    );
  });
}
```

4. Remove debug logging after confirming the fix works.
  </action>
  <verify>
1. Start an OpenCode session in or above the gsd-tui directory
2. Run `bun run dev`
3. Press 'c' - should show the OpenCode session in the picker
  </verify>
  <done>Session picker shows running OpenCode sessions when 'c' is pressed.</done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes
2. `bun run lint` passes
3. Footer shows 'c: connect' hint
4. With OpenCode running, pressing 'c' shows sessions in picker (not "No sessions found")
</verification>

<success_criteria>
- Footer displays 'c: connect' hint
- Session picker finds OpenCode sessions running in related directories
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-opencode-integration/04-06-SUMMARY.md`
</output>
