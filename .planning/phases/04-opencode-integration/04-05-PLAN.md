---
phase: 04-opencode-integration
plan: 05
type: execute
wave: 4
depends_on: ["04-02", "04-03", "04-04"]
files_modified:
  - src/app.tsx
  - src/lib/commands.ts
  - src/lib/types.ts
  - src/hooks/useTabNav.ts
  - src/hooks/useTabState.ts
  - src/components/layout/TabLayout.tsx
  - src/components/background/BackgroundView.tsx
  - src/components/background/JobEntry.tsx
  - src/components/background/ExecutionModePrompt.tsx
  - src/components/layout/Footer.tsx
autonomous: false

must_haves:
  truths:
    - "Background is the 4th tab in TabLayout (press 4 or Tab to reach)"
    - "User selects execution mode (headless/interactive/primary) when running queueable command"
    - "BackgroundView shows expandable job entries with output preview"
    - "Jobs can be cancelled with confirmation prompt"
    - "Footer shows context-sensitive shortcuts for Background tab"
  artifacts:
    - path: "src/components/background/BackgroundView.tsx"
      provides: "Fourth tab view for background jobs"
      exports: ["BackgroundView"]
    - path: "src/components/background/JobEntry.tsx"
      provides: "Expandable job entry component"
      exports: ["JobEntry"]
    - path: "src/components/background/ExecutionModePrompt.tsx"
      provides: "Modal for choosing execution mode"
      exports: ["ExecutionModePrompt"]
    - path: "src/components/layout/TabLayout.tsx"
      provides: "Updated to include 4th Background tab"
      contains: "background"
    - path: "src/lib/commands.ts"
      provides: "Commands with queueable flag"
      contains: "queueable"
  key_links:
    - from: "src/app.tsx"
      to: "src/hooks/useBackgroundJobs.ts"
      via: "hook usage"
      pattern: "useBackgroundJobs"
    - from: "src/components/layout/TabLayout.tsx"
      to: "src/components/background/BackgroundView.tsx"
      via: "renders BackgroundView for background tab"
      pattern: "activeTab === 'background'"
    - from: "src/components/background/ExecutionModePrompt.tsx"
      to: "execution mode selection"
      via: "user selects headless/interactive/primary"
      pattern: "onSelect.*mode"
---

<objective>
Wire background jobs to UI with 4th tab, execution mode selection, and expandable entries.

Purpose: Complete the integration per CONTEXT.md - Background as 4th tab, execution mode prompt, expandable entries, cancel with confirmation.
Output: Fully functional background job UI with all three execution modes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-opencode-integration/04-RESEARCH.md
@.planning/phases/04-opencode-integration/04-CONTEXT.md
@.planning/phases/04-opencode-integration/04-02-SUMMARY.md
@.planning/phases/04-opencode-integration/04-03-SUMMARY.md
@.planning/phases/04-opencode-integration/04-04-SUMMARY.md

@src/app.tsx
@src/lib/commands.ts
@src/lib/types.ts
@src/hooks/useTabNav.ts
@src/hooks/useTabState.ts
@src/components/layout/TabLayout.tsx
@src/components/layout/Footer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types and mark queueable commands</name>
  <files>src/lib/types.ts, src/lib/commands.ts</files>
  <action>
    1. Add execution mode type to `src/lib/types.ts`:
    ```typescript
    /** Execution mode for GSD commands */
    export type ExecutionMode = 'headless' | 'interactive' | 'primary';
    ```

    2. Update Command type in `src/lib/commands.ts` to include queueable flag:
    ```typescript
    export interface Command {
      name: string;
      description: string;
      key?: string;
      action: (showToast: (msg: string, type?: ToastType) => void) => void;
      queueable?: boolean;  // If true, prompts for execution mode
    }
    ```

    3. Mark GSD commands as queueable by adding `queueable: true`:

    Commands that SHOULD be queueable (can run in any mode):
    - add-todo
    - add-phase
    - insert-phase
    - progress
    - verify
    - discuss-phase
    - plan-phase
    - execute-phase

    Commands that should NOT be queueable (leave undefined/false):
    - spawn-opencode (already terminal handoff)
    - connect-session (session management)

    Example:
    ```typescript
    {
      name: 'plan-phase',
      description: 'Create phase plan',
      action: createStubAction('plan-phase'),
      queueable: true,
    },
    ```
  </action>
  <verify>
    1. `bun run typecheck` passes
    2. `bun run lint` passes
    3. ExecutionMode type exists
    4. Commands have queueable flag set appropriately
  </verify>
  <done>
    - ExecutionMode type defined
    - Command type has queueable field
    - GSD commands marked queueable: true
    - Session/spawn commands NOT marked queueable
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExecutionModePrompt component</name>
  <files>src/components/background/ExecutionModePrompt.tsx</files>
  <action>
    Create `src/components/background/ExecutionModePrompt.tsx`:

    ```typescript
    /**
     * Execution Mode Prompt
     * Per CONTEXT.md: Always prompt user for mode choice when running a command.
     * Three modes: headless, interactive, primary.
     */
    ```

    Props:
    - command: string              // Command being executed
    - hasActiveSession: boolean    // Whether a session is connected for "primary" mode
    - onSelect: (mode: ExecutionMode) => void
    - onCancel: () => void

    Display (modal-style overlay like FilePicker):
    ```
    +-----------------------------------------+
    | Execute: plan-phase                     |
    +-----------------------------------------+
    |                                         |
    | [H] Headless - Run in background        |
    |     TUI shows status, view in Background|
    |                                         |
    | [I] Interactive - New session           |
    |     Terminal hands off to OpenCode      |
    |                                         |
    | [P] Primary - Send to connected session |
    |     (dimmed if no session connected)    |
    |                                         |
    | Press Escape to cancel                  |
    +-----------------------------------------+
    ```

    Key bindings:
    - 'h' or 'H': Select headless mode
    - 'i' or 'I': Select interactive mode
    - 'p' or 'P': Select primary mode (only if hasActiveSession)
    - Escape: Cancel

    Use Box with border, background='black', same styling as other pickers.

    Primary mode should be dimColor if !hasActiveSession, and pressing 'p' should
    do nothing (or show brief toast "No session connected").
  </action>
  <verify>
    1. Component exists at src/components/background/ExecutionModePrompt.tsx
    2. `bun run typecheck` passes
    3. `bun run lint` passes
  </verify>
  <done>
    - ExecutionModePrompt displays three mode options
    - Keyboard shortcuts h/i/p select modes
    - Primary mode disabled when no active session
    - Escape cancels
  </done>
</task>

<task type="auto">
  <name>Task 3: Create BackgroundView and JobEntry components</name>
  <files>src/components/background/BackgroundView.tsx, src/components/background/JobEntry.tsx</files>
  <action>
    1. Create `src/components/background/JobEntry.tsx`:
    ```typescript
    /**
     * Job Entry Component
     * Per CONTEXT.md: Expandable entries, collapsed by default, expand to see full output.
     */
    ```

    Props:
    - job: BackgroundJob
    - isSelected: boolean
    - isExpanded: boolean
    - onToggleExpand: () => void
    - onCancel: () => void

    Display (collapsed):
    ```
    > [running] plan-phase 3           12:34:05
    ```
    - Status indicator with color (pending=yellow, running=cyan+spinner, complete=green, failed=red)
    - Command name
    - Timestamp (queued time for pending, start time for running, end time for complete)

    Display (expanded):
    ```
    v [complete] plan-phase 3          12:34:05
      Started: 12:34:05 | Completed: 12:35:42
      Output (truncated):
        Planning phase 3...
        Created 3 plans in 2 waves.
        ...
      [x] Cancel (if pending/running)
    ```
    - Show start/end times
    - Show output (truncate to ~10 lines, scroll if more needed - Claude's discretion)
    - Cancel button visible if job is pending or running

    Key bindings handled by parent (BackgroundView).

    2. Create `src/components/background/BackgroundView.tsx`:
    ```typescript
    /**
     * Background View Component
     * Per CONTEXT.md: Fourth tab in TabLayout, shows background jobs.
     */
    ```

    Props:
    - jobs: BackgroundJob[]
    - isActive: boolean
    - onCancel: (jobId: string) => void
    - showToast?: ToastFunction

    Features:
    - Vim navigation (j/k) through job list
    - Enter toggles expand/collapse on selected job
    - 'x' or 'd' to cancel selected job (with confirmation)
    - Empty state: "No background jobs. Queue commands with Ctrl+P."
    - Use useVimNav for navigation

    Confirmation for cancel (per CONTEXT.md: "Jobs cancelable with confirmation prompt"):
    - When user presses cancel key on a job:
      - Show inline confirmation: "Cancel [job]? (y/n)"
      - 'y' confirms, 'n' or Escape cancels
    - Alternative: use a simple confirm state within the component

    State:
    - selectedIndex (for navigation)
    - expandedJobIds: Set<string> (which jobs are expanded)
    - confirmingCancelId: string | null (which job is awaiting cancel confirmation)
  </action>
  <verify>
    1. Components exist at src/components/background/
    2. `bun run typecheck` passes
    3. `bun run lint` passes
  </verify>
  <done>
    - JobEntry displays job with status, command, timestamp
    - JobEntry expands to show output and cancel option
    - BackgroundView lists jobs with vim navigation
    - Enter toggles expand, x/d cancels with confirmation
    - Empty state handled
  </done>
</task>

<task type="auto">
  <name>Task 4: Update TabLayout for 4th tab</name>
  <files>src/hooks/useTabNav.ts, src/hooks/useTabState.ts, src/components/layout/TabLayout.tsx, src/lib/types.ts</files>
  <action>
    1. Update TabId type in `src/hooks/useTabState.ts` (or src/lib/types.ts if that's where it lives):
    ```typescript
    export type TabId = 'roadmap' | 'phase' | 'todos' | 'background';
    ```

    2. Update `src/hooks/useTabNav.ts` to support 4 tabs:
    - Ensure Tab key cycles through all 4 tabs
    - Number keys 1/2/3/4 select tabs directly

    3. Update `src/components/layout/TabLayout.tsx`:

    Add imports:
    ```typescript
    import { BackgroundView } from '../background/BackgroundView.tsx';
    import type { BackgroundJob } from '../../lib/types.ts';
    ```

    Add props for background jobs:
    ```typescript
    interface TabLayoutProps {
      // ... existing props
      backgroundJobs?: BackgroundJob[];
      onCancelJob?: (jobId: string) => void;
    }
    ```

    Update tabs array in TabBar:
    ```typescript
    const tabs: { id: TabId; label: string; key: string }[] = [
      { id: 'roadmap', label: 'Roadmap', key: '1' },
      { id: 'phase', label: 'Phase', key: '2' },
      { id: 'todos', label: 'Todos', key: '3' },
      { id: 'background', label: 'Background', key: '4' },
    ];
    ```

    Add Background tab rendering in both single-view and tabbed modes:
    ```tsx
    {activeTab === 'background' && (
      <BackgroundView
        jobs={backgroundJobs ?? []}
        isActive={isActive}
        onCancel={onCancelJob ?? (() => {})}
        showToast={showToast}
      />
    )}
    ```

    Update useTabNav initialization to include 4th tab:
    ```typescript
    const { activeTab, setActiveTab } = useTabNav<TabId>({
      tabs: ['roadmap', 'phase', 'todos', 'background'],
      initialTab: flags.only ?? 'roadmap',
      isActive: isActive && !isOnlyMode,
    });
    ```
  </action>
  <verify>
    1. `bun run typecheck` passes
    2. `bun run lint` passes
    3. TabId includes 'background'
    4. Tab bar shows 4 tabs
    5. Number 4 and Tab cycling reach Background tab
  </verify>
  <done>
    - TabId type includes 'background'
    - TabBar shows 4th "Background" tab with key [4]
    - BackgroundView renders when background tab is active
    - Tab navigation works for 4 tabs
  </done>
</task>

<task type="auto">
  <name>Task 5: Integrate execution mode prompt and background jobs into App</name>
  <files>src/app.tsx, src/components/layout/Footer.tsx</files>
  <action>
    1. Update `src/app.tsx`:

    Add imports:
    ```typescript
    import { useBackgroundJobs } from './hooks/useBackgroundJobs.ts';
    import { ExecutionModePrompt } from './components/background/ExecutionModePrompt.tsx';
    import { spawnOpencodeSession } from './lib/opencode.ts';
    import type { ExecutionMode, Command } from './lib/types.ts';
    ```

    Add state:
    ```typescript
    // Execution mode prompt state
    const [showModePrompt, setShowModePrompt] = useState(false);
    const [pendingCommand, setPendingCommand] = useState<Command | null>(null);

    // Background jobs (from Plan 04)
    const { jobs, add: addBackgroundJob, cancel: cancelBackgroundJob, isProcessing } =
      useBackgroundJobs({
        sessionId: activeSessionId,
        showToast,
      });
    ```

    Update command execution flow (when command is selected from palette):
    ```typescript
    const handleCommandSelect = (command: Command) => {
      setShowCommandPalette(false);

      if (command.queueable) {
        // Per CONTEXT.md: Always prompt user for mode choice
        setPendingCommand(command);
        setShowModePrompt(true);
      } else {
        // Non-queueable commands execute immediately (e.g., spawn-opencode)
        command.action(showToast);
      }
    };

    const handleModeSelect = (mode: ExecutionMode) => {
      setShowModePrompt(false);
      if (!pendingCommand) return;

      const commandName = pendingCommand.name;

      switch (mode) {
        case 'headless':
          // Add to background jobs
          addBackgroundJob(commandName);
          // Toast handled by useBackgroundJobs
          break;

        case 'interactive':
          // Spawn new session with this command
          const success = spawnOpencodeSession(`/gsd:${commandName}`);
          if (success) {
            showToast('OpenCode session completed', 'success');
          } else {
            showToast('OpenCode session failed or was cancelled', 'warning');
          }
          break;

        case 'primary':
          // Send to existing connected session
          if (!activeSessionId) {
            showToast("No session connected. Press 'c' to connect.", 'warning');
            return;
          }
          // Use sendPrompt directly (or add through background with special handling)
          addBackgroundJob(commandName);  // For now, treat same as headless
          showToast(`Sent to session: ${commandName}`, 'info');
          break;
      }

      setPendingCommand(null);
    };
    ```

    Pass background jobs to TabLayout:
    ```tsx
    <TabLayout
      data={data}
      flags={flags}
      // ... existing props
      backgroundJobs={jobs}
      onCancelJob={cancelBackgroundJob}
    />
    ```

    Render ExecutionModePrompt when showModePrompt is true:
    ```tsx
    {showModePrompt && pendingCommand && (
      <Box position="absolute" marginTop={3} marginLeft={2}>
        <ExecutionModePrompt
          command={pendingCommand.name}
          hasActiveSession={Boolean(activeSessionId)}
          onSelect={handleModeSelect}
          onCancel={() => {
            setShowModePrompt(false);
            setPendingCommand(null);
          }}
        />
      </Box>
    )}
    ```

    Update isActive checks to include !showModePrompt.

    2. Update `src/components/layout/Footer.tsx`:

    Add context-sensitive hints for Background tab:
    ```typescript
    if (activeTab === 'background') {
      return (
        <Box paddingX={2}>
          <Text dimColor>
            j/k Navigate | Enter Expand | x Cancel | 4 Background | ? Help | q Quit
          </Text>
        </Box>
      );
    }
    ```
  </action>
  <verify>
    1. `bun run typecheck` passes
    2. `bun run lint` passes
    3. Queueable commands show execution mode prompt
    4. Mode selection triggers appropriate action
    5. Background jobs passed to TabLayout
    6. Footer shows Background tab hints
  </verify>
  <done>
    - Queueable commands trigger ExecutionModePrompt
    - Headless mode adds to background jobs
    - Interactive mode spawns OpenCode session
    - Primary mode sends to connected session
    - Background tab shows jobs via TabLayout
    - Footer shows context-sensitive hints
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete OpenCode integration with execution modes, Background tab, and session management</what-built>
  <how-to-verify>
    **Minimum verification (no OpenCode server):**
    1. Run `bun start` in a project with .planning/ directory
    2. Verify 4 tabs visible: [1] Roadmap [2] Phase [3] Todos [4] Background
    3. Press 4 to switch to Background tab - should show empty state
    4. Press Ctrl+P to open command palette
    5. Select "plan-phase" (queueable command)
    6. Verify ExecutionModePrompt appears with three options (H/I/P)
    7. Press 'h' for headless - should show "Background: plan-phase queued" toast
    8. Press 4 to view Background tab - should show pending job
    9. Navigate to job with j/k, press Enter to expand
    10. Press 'x' to cancel - should show confirmation
    11. Press 'y' to confirm cancel

    **Interactive mode test:**
    1. Select a queueable command from palette
    2. Press 'i' for interactive mode
    3. OpenCode should launch (or fail gracefully if not installed)
    4. Exit OpenCode, TUI should resume

    **Session connection test:**
    1. Press 'c' to open session picker
    2. If no sessions: "No sessions found" with spawn option
    3. If sessions: verify ID + directory + last command format
    4. Select session to connect
    5. Select queueable command, press 'p' for primary
    6. Should send to connected session

    **Footer hints:**
    - Check Footer shows appropriate hints when on Background tab
    - Should include: j/k Navigate, Enter Expand, x Cancel

    Note: Full functionality requires OpenCode server. Basic UI should work without.
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
```bash
bun run typecheck && bun run lint && bun test
```

Manual verification as described in checkpoint task.
</verification>

<success_criteria>
1. Background is 4th tab accessible via key [4] and Tab cycling
2. ExecutionModePrompt appears for queueable commands
3. Three modes work: headless (background job), interactive (spawn), primary (send)
4. BackgroundView shows expandable job entries
5. Jobs can be cancelled with confirmation
6. Footer shows context-sensitive hints for Background tab
7. Session picker shows ID + directory + last command format
8. Empty session list offers to spawn new session
9. All type/lint/test checks pass
10. Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/04-opencode-integration/04-05-SUMMARY.md`
</output>
