---
phase: 04-opencode-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bun.lockb
  - src/lib/opencode.ts
  - src/lib/types.ts
  - src/hooks/useOpencodeConnection.ts
autonomous: true

must_haves:
  truths:
    - "SDK client can be created with configurable base URL"
    - "Server detection returns true when OpenCode server is running"
    - "Server detection returns false when server is not available"
    - "Connection hook exposes isConnected, client, and error states"
  artifacts:
    - path: "src/lib/opencode.ts"
      provides: "SDK client factory and server detection"
      exports: ["createClient", "detectServer"]
    - path: "src/hooks/useOpencodeConnection.ts"
      provides: "React hook for OpenCode connection management"
      exports: ["useOpencodeConnection"]
    - path: "src/lib/types.ts"
      provides: "OpenCode-related type definitions"
      contains: "OpencodeConnectionState"
  key_links:
    - from: "src/hooks/useOpencodeConnection.ts"
      to: "src/lib/opencode.ts"
      via: "import { createClient, detectServer }"
      pattern: "createClient|detectServer"
---

<objective>
Set up the OpenCode SDK client infrastructure and server detection.

Purpose: Establish the foundation for all OpenCode integration features by providing a typed client wrapper and connection management hook.
Output: SDK installed, client wrapper, connection hook ready for use in subsequent plans.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-opencode-integration/04-RESEARCH.md

@src/lib/types.ts
@src/hooks/useExternalEditor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install OpenCode SDK</name>
  <files>package.json, bun.lockb</files>
  <action>
    Run `bun add @opencode-ai/sdk` to install the OpenCode SDK.

    The SDK provides:
    - Type-safe client for OpenCode HTTP API
    - Session management methods
    - SSE event streaming

    No additional configuration needed - the package is ready to use.
  </action>
  <verify>
    1. Run `bun install` completes without errors
    2. Run `grep "@opencode-ai/sdk" package.json` shows the dependency
    3. Run `bun run typecheck` passes
  </verify>
  <done>@opencode-ai/sdk appears in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create OpenCode client wrapper</name>
  <files>src/lib/opencode.ts</files>
  <action>
    Create `src/lib/opencode.ts` with:

    1. `createClient(baseUrl?: string)` - Factory function that creates SDK client
       - Default baseUrl: `http://127.0.0.1:4096`
       - Timeout: 5000ms
       - Returns the SDK client instance

    2. `detectServer(port?: number)` - Async function to check if server is running
       - Default port: 4096
       - Try to call health endpoint via createClient
       - Return true if health check succeeds, false otherwise
       - Catch all errors and return false (graceful degradation)

    3. `DEFAULT_PORT` constant exported for reuse

    Follow the patterns from RESEARCH.md:
    ```typescript
    import { createOpencodeClient } from "@opencode-ai/sdk";
    ```

    Keep this file focused on client creation and detection only. Session management will be in hooks.
  </action>
  <verify>
    1. File exists at src/lib/opencode.ts
    2. `bun run typecheck` passes
    3. Exports: createClient, detectServer, DEFAULT_PORT
  </verify>
  <done>
    - createClient creates SDK client with configurable baseUrl
    - detectServer returns boolean based on health check
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add types and create connection hook</name>
  <files>src/lib/types.ts, src/hooks/useOpencodeConnection.ts</files>
  <action>
    1. Add to `src/lib/types.ts`:
    ```typescript
    /** OpenCode connection state */
    export interface OpencodeConnectionState {
      isConnected: boolean;
      isChecking: boolean;
      serverVersion?: string;
      error?: Error;
    }
    ```

    2. Create `src/hooks/useOpencodeConnection.ts`:
    ```typescript
    /**
     * OpenCode Connection Hook
     * Manages connection to OpenCode server with automatic detection.
     */
    ```

    Hook implementation:
    - State: OpencodeConnectionState (isConnected, isChecking, serverVersion, error)
    - On mount: Call detectServer() to check if server is available
    - Expose: { ...state, client, checkConnection }
    - client is null when not connected
    - checkConnection() allows manual recheck

    Use useEffect for initial detection, useState for state.

    Pattern from existing hooks:
    - useCallback for stable function references
    - Proper cleanup on unmount (though detection is fast, no cleanup needed)
  </action>
  <verify>
    1. `bun run typecheck` passes
    2. `bun run lint` passes (run `bun run lint:fix` if needed)
    3. Hook exports useOpencodeConnection
    4. Types include OpencodeConnectionState
  </verify>
  <done>
    - OpencodeConnectionState type exists
    - useOpencodeConnection hook provides connection state and client
    - isConnected reflects server availability
    - client is typed SDK client or null
  </done>
</task>

</tasks>

<verification>
Run full validation:
```bash
bun run typecheck && bun run lint && bun test
```

All checks should pass. Tests may not cover new code yet (Phase 5).
</verification>

<success_criteria>
1. @opencode-ai/sdk installed in package.json
2. src/lib/opencode.ts exports createClient, detectServer, DEFAULT_PORT
3. src/hooks/useOpencodeConnection.ts exports connection hook
4. TypeScript and lint checks pass
5. No runtime errors when importing the new modules
</success_criteria>

<output>
After completion, create `.planning/phases/04-opencode-integration/04-01-SUMMARY.md`
</output>
