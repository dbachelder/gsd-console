---
phase: 03.1-ui-polish
plan: 04
type: execute
wave: 1
depends_on: ["03.1-03"]
files_modified:
  - src/hooks/useTabState.ts
  - src/components/roadmap/RoadmapView.tsx
  - src/components/layout/TabLayout.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Roadmap expanded phases persist when switching tabs"
    - "Roadmap selected index persists when switching tabs"
    - "State is session-only (no persistence across TUI restarts)"
  artifacts:
    - path: "src/hooks/useTabState.ts"
      provides: "Extended TabState with expandedPhases and selectedIndex"
      exports: ["useTabState", "TabState"]
    - path: "src/components/roadmap/RoadmapView.tsx"
      provides: "Controlled RoadmapView with state callbacks"
      exports: ["RoadmapView"]
    - path: "src/components/layout/TabLayout.tsx"
      provides: "Wired roadmap state persistence"
      exports: ["TabLayout"]
---

<objective>
Fix roadmap state persistence - expanded phases and selection should persist when switching tabs.

Root cause: RoadmapView has internal state (expandedPhases, selectedIndex) not wired to useTabState.
Fix: Extend TabState, make RoadmapView controlled, wire in TabLayout.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Extend useTabState with roadmap fields</name>
  <files>src/hooks/useTabState.ts</files>
  <action>
Add roadmap-specific fields to TabState interface:

```tsx
export interface TabState {
  selectedPhaseNumber?: number;
  detailLevel?: number;
  scrollOffset?: number;
  selectedTodoId?: string;
  // NEW: Roadmap state
  expandedPhases?: number[];  // Array of expanded phase numbers
  selectedIndex?: number;     // Currently selected row index
}
```

Update initial state for roadmap tab:
```tsx
roadmap: { expandedPhases: [], selectedIndex: 0, scrollOffset: 0 },
```
</action>
  <verify>
  Run `npx tsc --noEmit` to verify TypeScript compilation
  </verify>
  <done>TabState extended with expandedPhases and selectedIndex fields</done>
</task>

<task type="auto">
  <name>Task 2: Make RoadmapView controlled</name>
  <files>src/components/roadmap/RoadmapView.tsx</files>
  <action>
Update RoadmapView to accept controlled state props:

1. Add new props:
   - `expandedPhases?: number[]` - externally controlled expanded state
   - `onExpandedPhasesChange?: (phases: number[]) => void` - callback when expanded changes
   - `selectedIndex?: number` - externally controlled selection
   - `onSelectedIndexChange?: (index: number) => void` - callback when selection changes

2. Remove internal useState for expandedPhases if external prop provided:
   - Use prop if provided, else fallback to internal state
   - Call callback when state changes

3. Wire useVimNav to report selection changes:
   - Get initialIndex from prop
   - Call onSelectedIndexChange when selection changes

4. Remove underscore prefix from props that are now used.

Pattern for controlled/uncontrolled:
```tsx
// Use external state if provided, else internal
const [internalExpanded, setInternalExpanded] = useState<Set<number>>(new Set());
const expandedSet = expandedPhases
  ? new Set(expandedPhases)
  : internalExpanded;

const handleToggle = (phaseNumber: number) => {
  const next = new Set(expandedSet);
  if (next.has(phaseNumber)) {
    next.delete(phaseNumber);
  } else {
    next.add(phaseNumber);
  }
  // Report to parent if controlled
  onExpandedPhasesChange?.([...next]);
  // Update internal if uncontrolled
  if (!expandedPhases) {
    setInternalExpanded(next);
  }
};
```
</action>
  <verify>
  Run `npx tsc --noEmit` to verify TypeScript compilation
  </verify>
  <done>RoadmapView accepts controlled state props with callbacks</done>
</task>

<task type="auto">
  <name>Task 3: Wire roadmap state in TabLayout</name>
  <files>src/components/layout/TabLayout.tsx</files>
  <action>
Wire roadmap state persistence in TabLayout:

1. Get roadmap tab state:
```tsx
const roadmapTabState = getTab('roadmap');
const expandedPhases = roadmapTabState.expandedPhases ?? [];
const roadmapSelectedIndex = roadmapTabState.selectedIndex ?? 0;
```

2. Add handlers:
```tsx
const handleExpandedPhasesChange = (phases: number[]) => {
  setTab('roadmap', { expandedPhases: phases });
};

const handleRoadmapSelectedIndexChange = (index: number) => {
  setTab('roadmap', { selectedIndex: index });
};
```

3. Pass to RoadmapView:
```tsx
<RoadmapView
  phases={data.phases}
  isActive={isActive}
  onSelectPhase={handleSelectPhase}
  onPhaseNavigate={onPhaseSelect}
  isPhaseHighlighted={isPhaseHighlighted}
  isPhaseFading={isPhaseFading}
  showToast={showToast}
  expandedPhases={expandedPhases}
  onExpandedPhasesChange={handleExpandedPhasesChange}
  selectedIndex={roadmapSelectedIndex}
  onSelectedIndexChange={handleRoadmapSelectedIndexChange}
/>
```

Update both instances (single view mode and tabbed layout).
</action>
  <verify>
  Run `bun run dev` and verify:
  1. Expand a phase in roadmap (right arrow)
  2. Switch to Phase tab
  3. Switch back to Roadmap tab
  4. Phase should still be expanded
  5. Selection should be preserved
  </verify>
  <done>Roadmap state wired through TabLayout via useTabState</done>
</task>

</tasks>

<success_criteria>
- Roadmap expanded phases persist when switching tabs
- Roadmap selected index persists when switching tabs
- State is session-only (React state, no LocalStorage)
- No regressions in other tab state (phase detail level still works)
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-ui-polish/03.1-04-SUMMARY.md`
</output>
