---
phase: 03.1-ui-polish
plan: 03
type: execute
wave: 3
depends_on: ["03.1-02"]
files_modified:
  - src/components/phase/PhaseView.tsx
  - src/lib/parser.ts
autonomous: false

must_haves:
  truths:
    - "User sees plan summary, task count, and wave info in phase view"
    - "Plan list displays cleanly below phase details"
    - "Plan summaries are parsed from ROADMAP.md (not PLAN.md frontmatter)"
    - "Plan wave and task count are parsed from PLAN.md files using gray-matter"
    - "Visual design looks good and provides useful context"
  artifacts:
    - path: "src/components/phase/PhaseView.tsx"
      provides: "Plan list display in phase view"
      exports: ["PhaseView"]
    - path: "src/lib/parser.ts"
      provides: "PLAN.md parsing and ROADMAP.md summary extraction"
      exports: ["parsePlanFiles", "readRoadmapPlans"]
  key_links:
    - from: "src/components/phase/PhaseView.tsx"
      to: "src/lib/parser.ts"
      via: "parsePlanFiles function call"
      pattern: "parsePlanFiles"
    - from: "src/lib/parser.ts"
      to: ".planning/ROADMAP.md"
      via: "readRoadmapPlans regex parsing"
      pattern: "readRoadmapPlans"
---

<objective>
Parse and display PLAN.md files in phase view to show plan summary, task count, and wave information.

Purpose: User should see plan details (summary, task count, wave info) inline in phase view to understand what work is planned for each phase.
Output: Updated PhaseView component with plan list display and parsePlanFiles utility
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-ui-polish/03.1-CONTEXT.md
@.planning/phases/03.1-ui-polish/03.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parse PLAN.md files to extract summary, task count, and wave info</name>
  <files>src/lib/parser.ts</files>
  <action>
Add parsePlanFiles function to src/lib/parser.ts to parse PLAN.md files:

```tsx
import { readdirSync, readFileSync } from 'node:fs';
import matter from 'gray-matter';

export interface PlanInfo {
  id: string;  // Plan number like "01", "02"
  summary: string;
  taskCount: number;
  wave: number;
}

// Extract plan summaries from ROADMAP.md (Plan summaries live there, not in PLAN.md frontmatter)
function readRoadmapPlans(phaseId: string): Map<string, string> {
  const roadmapContent = readFileSync('.planning/ROADMAP.md', 'utf-8');

  // Find the phase section (handles both integer and decimal phases like "03.1")
  const sectionRegex = new RegExp(`Phase ${phaseId.replace('\\.', '\\.')}:.*?Plans:([\\s\\S]*?)(?=###|$)`, 'i');
  const section = roadmapContent.match(sectionRegex)?.[1] ?? '';

  const summaryMap = new Map<string, string>();
  const planRegex = /- \[.\] ([\d.]+-\d+-PLAN\.md) — (.+)/g;
  let match;

  while ((match = planRegex.exec(section)) !== null) {
    const planFile = match[1];  // e.g., "03.1-01-PLAN.md"
    const summary = match[2];    // e.g., "Sticky footer, tab styling..."
    const planId = planFile.match(/-(\d+)-PLAN\.md$/)?.[1] ?? '';
    if (planId) summaryMap.set(planId, summary);
  }

  return summaryMap;
}

export function parsePlanFiles(phaseDir: string, phaseNumber: number, phaseId?: string): PlanInfo[] {
  const plans: PlanInfo[] = [];

  try {
    // Get plan summaries from ROADMAP.md (summary lives there, not in PLAN.md frontmatter)
    const summaryMap = readRoadmapPlans(phaseId ?? String(phaseNumber));

    // Find all PLAN.md files in phase directory
    const files = readdirSync(phaseDir);
    const planFiles = files.filter(f => f.includes('PLAN.md') && f.includes(`-${phaseNumber}-`));

    for (const file of planFiles) {
      const filePath = `${phaseDir}/${file}`;
      const raw = readFileSync(filePath, 'utf-8');
      const { data } = matter(raw);

      // Extract plan number from filename (e.g., "01-02-PLAN.md" -> "02")
      const planMatch = file.match(/-(\d+)-PLAN\.md/);
      const planId = planMatch?.[1] ?? '??';

      plans.push({
        id: planId,
        summary: summaryMap.get(planId) || 'No summary available',
        taskCount: parseTaskCount(raw),
        wave: (data.wave as number) || 1,
      });
    }
  } catch {
    // Return empty array if phase directory doesn't exist or parsing fails
    return [];
  }

  // Sort by plan ID
  return plans.sort((a, b) => parseInt(a.id, 10) - parseInt(b.id, 10));
}

function parseTaskCount(content: string): number {
  // Count <task> tags in PLAN.md content
  const taskMatches = content.match(/<task/g);
  return taskMatches?.length ?? 0;
}
```

Key change: Summaries come from ROADMAP.md (format: `- [ ] {plan-id} — {summary}`), not from PLAN.md frontmatter.

DO NOT write custom YAML parser - use existing gray-matter (per RESEARCH.md don't-hand-roll rule).
DO use readPlanningFile utility if available (check existing code).
DO handle missing phase directories gracefully (return empty array).
</action>
  <verify>
  Run `npx tsc --noEmit` to verify TypeScript compilation
  </verify>
  <done>parsePlanFiles function created that extracts summary from ROADMAP.md, task count and wave info from PLAN.md files</done>
</task>

<task type="auto">
  <name>Task 2: Render plan list in PhaseView component</name>
  <files>src/components/phase/PhaseView.tsx</files>
  <action>
Update PhaseView component to display plan list:

1. Add planningDir prop to PhaseViewProps interface (passed from App.tsx or parent component)
2. Add phaseId prop to pass to parsePlanFiles (needed to read summaries from ROADMAP.md)
3. Call parsePlanFiles to get plan data using phase.number and phase.id
4. Render plan list below phase content

```tsx
import { parsePlanFiles, type PlanInfo } from '../../lib/parser.ts';

interface PhaseViewProps {
  // ... existing props
  phase: Phase | null;
  allPhases: Phase[];
  planningDir?: string;  // From App.tsx (default: '.planning')
}

export function PhaseView({ phase, allPhases, planningDir = '.planning', ... }: PhaseViewProps) {
  // ... existing code

  // Parse plan files for current phase
  // Note: planningDir comes from App.tsx (usually '.planning')
  const plans: PlanInfo[] = phase && planningDir
    ? parsePlanFiles(`${planningDir}/phases`, phase.number, phase.id)
    : [];

  // ... rest of component

  return (
    <Box flexDirection="column" paddingX={1} flexGrow={1}>
      {/* ... existing phase header and content ... */}

      {/* Plans section */}
      {plans.length > 0 && (
        <Box flexDirection="column" marginTop={1}>
          <Box marginBottom={1}>
            <Text bold color="yellow">Plans:</Text>
          </Box>
          {plans.map((plan) => (
            <Box key={plan.id} marginLeft={1}>
              <Text>
                <Text color="cyan">{plan.id}</Text>: {plan.summary}
                {' '}
                <Text dimColor>(Wave {plan.wave}, {plan.taskCount} tasks)</Text>
              </Text>
            </Box>
          ))}
        </Box>
      )}

      {/* ... existing navigation hints ... */}
    </Box>
  );
}
```

Visual design should look like:
```
Phase 1: Core TUI
Goal: User can view GSD project status...

Plans:
  01: Project setup, tooling, types (Wave 1, 3 tasks)
  02: Roadmap/Phase/Todos views (Wave 1, 2 tasks)
  03: UAT gap closure (Wave 2, 6 tasks)
```

DO NOT implement full plan navigation - display summary list only (per CONTEXT.md: "Navigation depth left to Claude's discretion").
DO make plan list visually clean and easy to scan.
DO pass phase.id to parsePlanFiles so it can extract summaries from ROADMAP.md correctly.
</action>
  <verify>
  Run `bun run dev` and verify:
  1. Navigate to phase with completed plans (e.g., Phase 1)
  2. Verify "Plans:" section appears below phase content
  3. Verify plan summaries are displayed correctly
  4. Verify wave info and task count are shown
  5. Visual design should be clean and readable
  </verify>
  <done>Plan list displayed in phase view with summary, wave info, and task count</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete phase view with plan list display showing summary, task count, and wave information</what-built>
  <how-to-verify>
  1. Run `bun run dev` to start TUI
  2. Navigate to a phase that has completed plans (e.g., Phase 1 or Phase 2)
  3. Verify the "Plans:" section appears below the phase details
  4. Check that each plan shows:
     - Plan number (e.g., "01", "02")
     - Plan summary (brief description)
     - Wave number (e.g., "Wave 1", "Wave 2")
     - Task count (e.g., "3 tasks")
  5. Verify visual design is clean and easy to read
  6. Check that plans are sorted by plan number
  7. Test with multiple phases to ensure consistency
  </how-to-verify>
  <resume-signal>Type "approved" if plan display looks good, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Parse ROADMAP.md and PLAN.md files and display plan information:
1. readRoadmapPlans extracts plan summaries from ROADMAP.md using regex
2. parsePlanFiles extracts task count and wave info from PLAN.md files using gray-matter
3. PhaseView renders plan list below phase details
4. Visual design is clean and provides useful context
5. Plans are sorted by plan number
</verification>

<success_criteria>
- ROADMAP.md parsed correctly to extract plan summaries via regex
- PLAN.md files parsed correctly using gray-matter for wave and task count
- Plan list displays in phase view with summary, task count, and wave info
- Visual design is clean and easy to scan
- Plans sorted by plan number
- User approves visual design in checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-ui-polish/03.1-03-SUMMARY.md`
</output>
