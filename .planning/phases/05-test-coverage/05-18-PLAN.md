---
phase: 05-test-coverage
plan: 18
type: execute
wave: 4
depends_on: [05-11, 05-12, 05-13, 05-14, 05-15, 05-16, 05-17]
files_modified: []
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "All tests pass consistently (no flaky tests)"
    - "Tests use mocked filesystem, not real .planning/ directory"
    - "Line coverage reaches 80% or higher"
    - "Parser functions have comprehensive test cases"
    - "Hook functions have test coverage where feasible"
  artifacts:
    - path: "coverage/lcov-report/index.html" or similar
      provides: "Overall coverage report for entire codebase"
      verifies: "80%+ line coverage target"
  key_links:
    - from: "bun test --coverage"
      to: "src/"
      via: "Coverage report generation"
      pattern: "coverage report.*80%"
---

<objective>
Verify all gaps closed: full test suite passes, 80%+ coverage achieved, no flaky tests, all hooks tested.

Purpose: Final verification that all Phase 5 gaps are addressed and success criteria met.

Output: Confirmation that all 5 success criteria from VERIFICATION.md are now satisfied.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-coverage/05-VERIFICATION.md
@.planning/phases/05-test-coverage/05-11-SUMMARY.md
@.planning/phases/05-test-coverage/05-12-SUMMARY.md
@.planning/phases/05-test-coverage/05-13-SUMMARY.md
@.planning/phases/05-test-coverage/05-14-SUMMARY.md
@.planning/phases/05-test-coverage/05-15-SUMMARY.md
@.planning/phases/05-test-coverage/05-16-SUMMARY.md
@.planning/phases/05-test-coverage/05-17-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Run full test suite and verify no hanging</name>
  <files></files>
  <action>
    Run complete test suite to verify it completes without hanging (critical blocker from VERIFICATION.md).

    ```bash
    bun test
    ```

    Expected outcome from 05-11 (useChangeHighlight fixes):
    - All test files run to completion
    - No React warnings about setState during render
    - Test runner exits normally (not hanging)
    - Summary shows all tests passing

    Record output:
    - Total tests run
    - Tests passing vs failing
    - Any warnings or errors

    If test suite hangs:
    1. Note which test file causes hang
    2. Check for React warnings in output
    3. Document in task output for investigation

    If tests fail:
    1. Identify which test file(s) have failures
    2. Check if failures are in new gap closure tests
    3. Note specific test names and error messages

    This task verifies the critical blocker from VERIFICATION.md is resolved.
  </action>
  <verify>bun test 2>&1 | tail -20</verify>
  <done>Full test suite runs to completion, no hanging, all tests pass</done>
</task>

<task type="auto">
  <name>Generate overall coverage report and verify 80%+ target</name>
  <files></files>
  <action>
    Run test suite with coverage to generate overall coverage report for entire codebase.

    ```bash
    bun test --coverage
    ```

    Check coverage report output for overall line coverage.

    Based on VERIFICATION.md gap coverage:
    - parser.ts was 66.56% (below target)
    - 17 source files had no tests (38.6% of codebase)
    - 4 hooks were completely untested

    After gap closure plans, verify improvements:
    1. Overall line coverage >= 80%
    2. parser.ts coverage increased (was 66.56%, target 80%+)
    3. Hook coverage improved (9/13 → 13/13 hooks tested)

    If using coverage/lcov-report/index.html format:
    ```bash
    # Open coverage report in browser (if available)
    # Or parse from terminal output
    ```

    If coverage < 80%:
    1. Identify files with lowest coverage
    2. Check if they're from gap closure plans
    3. Note which files still need more tests
    4. Document in task output

    Key coverage targets from VERIFICATION.md:
    - All 5 success criteria must be TRUE
    - "Line coverage reaches 80% or higher" is critical
    - "Parser functions have comprehensive test cases" (5 failing tests fixed)
    - "Hook functions have test coverage where feasible" (13/13 hooks tested)
  </action>
  <verify>bun test --coverage 2>&1 | grep -E "(All files|Coverage|lines)" | tail -10</verify>
  <done>Overall coverage report shows 80%+ line coverage</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Full verification of Phase 5 success criteria</what-built>
  <how-to-verify>
    Run full test suite 3 times to verify no flaky tests:

    ```bash
    # Run 1
    bun test

    # Run 2
    bun test

    # Run 3
    bun test
    ```

    Each run should:
    - Complete without hanging
    - Show all tests passing
    - Have identical test counts (same number of passing/failing)
    - No intermittent failures

    Then check coverage report:

    ```bash
    bun test --coverage
    ```

    Verify:
    1. Overall line coverage >= 80%
    2. All 13 hooks have test coverage
    3. parser.ts coverage >= 80% (was 66.56%)
    4. No source files at 0% coverage (17 files were untested before)

    Finally, review VERIFICATION.md gaps:
    1. ✅ "All tests pass consistently" - verified by 3 runs
    2. ✅ "Tests use mocked filesystem" - memfs used throughout
    3. ✅ "Line coverage reaches 80%+" - check coverage report
    4. ✅ "Parser functions comprehensive" - 5 failing tests fixed
    5. ✅ "Hook functions have coverage" - 13/13 hooks tested

    If any criteria not met:
    - Note which gap remains
    - Identify additional work needed
    - Record in verification output
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 success criteria met, or describe remaining gaps</resume-signal>
</task>

<task type="auto">
  <name>Document verification results and update VERIFICATION.md</name>
  <files>.planning/phases/05-test-coverage/05-VERIFICATION.md</files>
  <action>
    Update VERIFICATION.md with final verification results.

    Read current VERIFICATION.md and update frontmatter:
    ```yaml
    ---
    phase: 05-test-coverage
    verified: 2026-01-25T00:00:00Z
    status: complete
    score: 5/5 must-haves verified
    gaps: []
    ---

    # Phase 5: Test Coverage Verification Report

    **Phase Goal:** Reproducible tests with mocked filesystem to reach 80%+ line coverage
    **Verified:** 2026-01-25T00:00:00Z
    **Status:** ✅ COMPLETE
    **Re-verification:** Yes — all gaps addressed via gap closure plans
    ```

    Update Goal Achievement section:
    ```markdown
    ## Goal Achievement

    ### Observable Truths

    | #   | Truth                                                                   | Status     | Evidence                                                                                                |
    | --- | ----------------------------------------------------------------------- | ---------- | ------------------------------------------------------------------------------------------------------ |
    | 1   | All tests pass consistently (no flaky tests)                             | ✅ PASSED   | Full test suite runs 3x without hanging or intermittent failures. All tests pass on each run.             |
    | 2   | Tests use mocked filesystem, not real .planning/ directory               | ✅ PASSED   | All tests use vi.mock('node:fs') with memfs for isolated test environments.              |
    | 3   | Line coverage reaches 80% or higher                                     | ✅ PASSED   | Overall coverage: XX.XX%. parser.ts: XX.XX% (was 66.56%), all hooks tested.             |
    | 4   | Parser functions have comprehensive test cases                            | ✅ PASSED   | All 26 parser tests passing. Added tests for readRoadmapPlans, parseTaskCount, parsePlanFiles.  |
    | 5   | Hook functions have test coverage where feasible                         | ✅ PASSED   | 13/13 hooks tested (100%). Added tests for useCommandPalette, useExternalEditor, useGsdData, useSessionActivity. |
    ```

    Update Required Artifacts and Key Link Verification sections with ✅ status.

    Document gap closure work:
    ```markdown
    ## Gap Closure Summary

    **Plans Executed:**
    - 05-11-PLAN.md: Fixed useChangeHighlight React warnings (unblock test suite)
    - 05-12-PLAN.md: Fixed 5 failing parser tests (success criteria, plans count)
    - 05-13-PLAN.md: Added parser coverage for uncovered functions (80%+ achieved)
    - 05-14-PLAN.md: Added useCommandPalette hook tests (10/13 hooks tested)
    - 05-15-PLAN.md: Added useExternalEditor hook tests (11/13 hooks tested)
    - 05-16-PLAN.md: Added useGsdData hook tests (12/13 hooks tested)
    - 05-17-PLAN.md: Added useSessionActivity hook tests (13/13 hooks tested)
    - 05-18-PLAN.md: Final verification (this plan)

    **Coverage Improvements:**
    - Parser: 66.56% → 80%+
    - Hooks: 9/13 → 13/13 tested (100%)
    - Overall: <XX%> → 80%+
    ```

    Replace <XX%> with actual coverage numbers from task 2.
  </action>
  <verify>grep "status: complete" .planning/phases/05-test-coverage/05-VERIFICATION.md</verify>
  <done>VERIFICATION.md updated with complete status and final results</done>
</task>

</tasks>

<verification>
After completion, verify:
1. Full test suite runs 3 times consistently without flaky failures
2. Coverage report shows 80%+ overall line coverage
3. All 5 success criteria from VERIFICATION.md are satisfied
4. VERIFICATION.md updated with complete status and verification results
5. No gaps remain in gaps: [] array
</verification>

<success_criteria>
- All tests pass consistently (verified by 3 consecutive runs)
- Overall line coverage reaches 80% or higher
- All 13 hooks have test coverage (100%)
- Parser tests all pass (26/26 tests)
- VERIFICATION.md updated with complete status (5/5 criteria verified)
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-18-SUMMARY.md`
</output>
