---
phase: 05-test-coverage
plan: 07
type: execute
wave: 5
depends_on: [05-01]
files_modified:
  - test/hooks/useOpencodeConnection.test.ts
  - test/hooks/useBackgroundJobs.test.ts
  - test/hooks/useSessionEvents.test.ts
autonomous: true
must_haves:
  truths:
    - "useOpencodeConnection tests pass (connects, detects sessions)"
    - "useBackgroundJobs tests pass (queues jobs, tracks status)"
    - "useSessionEvents tests pass (SSE event handling)"
  artifacts:
    - path: test/hooks/useOpencodeConnection.test.ts
      provides: "OpenCode connection hook tests with mocked SDK"
      min_lines: 80
    - path: test/hooks/useBackgroundJobs.test.ts
      provides: "Background jobs hook tests"
      min_lines: 80
    - path: test/hooks/useSessionEvents.test.ts
      provides: "Session events hook tests"
      min_lines: 50
  key_links:
    - from: test/hooks/useOpencodeConnection.test.ts
      to: src/hooks/useOpencodeConnection.ts
      via: "vi.mock('@opencode-ai/sdk')"
      pattern: "vi\\.mock\\(.*@opencode-ai/sdk"
---

<objective>
Add test coverage for OpenCode integration hooks with mocked @opencode-ai/sdk to avoid real HTTP calls.

Purpose: OpenCode SDK integration requires mocking HTTP calls. Use vi.mock to replace SDK with mock client that simulates server detection, session listing, and SSE events. Address Open Question 2 from 05-RESEARCH.md.

Output: OpenCode hooks tested with mocked SDK, no real HTTP calls made.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/05-test-coverage/05-RESEARCH.md
@src/hooks/useOpencodeConnection.ts
@src/hooks/useBackgroundJobs.ts
@src/hooks/useSessionEvents.ts
@.planning/phases/05-test-coverage/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add useOpencodeConnection tests with mocked SDK</name>
  <files>test/hooks/useOpencodeConnection.test.ts</files>
  <action>
    Create test/hooks/useOpencodeConnection.test.ts:

    Follow Open Question 2 from 05-RESEARCH.md - mock @opencode-ai/sdk:

    ```typescript
    import { describe, expect, test, beforeEach, vi, useRef } from 'bun:test';
    import { render } from 'ink-testing-library';
    import { useOpencodeConnection } from '../../src/hooks/useOpencodeConnection.ts';

    // Mock @opencode-ai/sdk to simulate server responses without HTTP calls
    vi.mock('@opencode-ai/sdk', () => ({
      Client: vi.fn().mockImplementation(() => ({
        session: {
          list: vi.fn().mockResolvedValue([
            { id: 'session-1', title: 'Test Session', workingDirectory: '/Users/dan/src/gsd-tui' },
          ]),
        },
      })),
    }));

    describe('useOpencodeConnection', () => {
      beforeEach(() => {
        vi.clearAllMocks();
      });

      test('detects connected session on mount', async () => {
        const connectionRef = useRef<any>(null);

        const TestComponent = () => {
          const { connected, session } = useOpencodeConnection();
          connectionRef.current = { connected, session };
          return null;
        };

        render(<TestComponent />);

        // Wait for async session list call
        await new Promise(resolve => setTimeout(resolve, 100));

        expect(connectionRef.current?.connected).toBe(true);
        expect(connectionRef.current?.session?.title).toBe('Test Session');
      });

      test('handles connection errors gracefully', async () => {
        const { Client } = await import('@opencode-ai/sdk');
        vi.mocked(Client).mockImplementationOnce(() => ({
          session: {
            list: vi.fn().mockRejectedValue(new Error('Connection failed')),
          },
        }));

        const connectionRef = useRef<any>(null);

        const TestComponent = () => {
          const { connected, error } = useOpencodeConnection();
          connectionRef.current = { connected, error };
          return null;
        };

        render(<TestComponent />);

        await new Promise(resolve => setTimeout(resolve, 100));

        expect(connectionRef.current?.connected).toBe(false);
        expect(connectionRef.current?.error).toContain('Connection failed');
      });

      // Add tests:
      // - Filters sessions by working directory (from 04-03 decision)
      // - Handles no sessions available
      // - Manually recheck on button click
      // - Path normalization (from 04-06 decision)
    });
    ```

    Based on CLAUDE.md "Session detection" and "Session picker" features.
  </action>
  <verify>bun test test/hooks/useOpencodeConnection.test.ts</verify>
  <done>useOpencodeConnection tests pass (detection, filtering, errors)</done>
</task>

<task type="auto">
  <name>Add useBackgroundJobs tests</name>
  <files>test/hooks/useBackgroundJobs.test.ts</files>
  <action>
    Create test/hooks/useBackgroundJobs.test.ts:

    Test cases:
    - Queues job with command and mode (headless, interactive, primary)
    - Updates job status to running
    - Accumulates job output during execution
    - Marks job as complete with output attached
    - Handles job errors
    - Returns list of pending and completed jobs
    - Manages job ordering (FIFO)

    Based on CLAUDE.md "Command queue with SSE events" and "Job queue state" sections.
    Use vi.mock for SSE event simulation.
  </action>
  <verify>bun test test/hooks/useBackgroundJobs.test.ts</verify>
  <done>useBackgroundJobs tests pass (queue, status updates, output accumulation)</done>
</task>

<task type="auto">
  <name>Add useSessionEvents tests</name>
  <files>test/hooks/useSessionEvents.test.ts</files>
  <action>
    Create test/hooks/useSessionEvents.test.ts:

    Test cases:
    - Subscribes to SSE events from SDK
    - Handles message events (job status, output)
    - Handles error events
    - Enables subscription only when jobs exist or running
    - Unsubscribes on unmount
    - Accumulates output via ref (from 04-04 decision)

    Based on CLAUDE.md "Enable event subscription only when pending jobs exist or job running" decision.
  </action>
  <verify>bun test test/hooks/useSessionEvents.test.ts</verify>
  <done>useSessionEvents tests pass (SSE events, subscription control)</done>
</task>

</tasks>

<verification>
Run `bun test test/hooks/useOpencodeConnection.test.ts test/hooks/useBackgroundJobs.test.ts test/hooks/useSessionEvents.test.ts` - all tests must pass.
Run `bun test --coverage` - verify OpenCode hooks have >= 70% coverage.
</verification>

<success_criteria>
- useOpencodeConnection tests cover server detection, session filtering, errors
- useBackgroundJobs tests cover job queuing, status updates, output accumulation
- useSessionEvents tests cover SSE event subscription and cleanup
- @opencode-ai/sdk properly mocked, no real HTTP calls
- OpenCode hooks coverage >= 70%
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-07-SUMMARY.md`
</output>
