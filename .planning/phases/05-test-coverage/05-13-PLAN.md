---
phase: 05-test-coverage
plan: 13
type: execute
wave: 3
depends_on: [05-11, 05-12]
files_modified: [test/lib/parser.test.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Line coverage reaches 80% or higher"
    - "Parser functions have comprehensive test cases"
    - "parser.ts coverage increased from 66.56% to 80%+"
  artifacts:
    - path: "test/lib/parser.test.ts"
      provides: "Tests for uncovered parser functions"
      adds: "readRoadmapPlans, parseTaskCount, parsePlanFiles"
  key_links:
    - from: "test/lib/parser.test.ts"
      to: "src/lib/parser.ts"
      via: "New test cases for uncovered functions"
      pattern: "readRoadmapPlans|parseTaskCount|parsePlanFiles"
---

<objective>
Add test coverage for three uncovered parser functions (readRoadmapPlans, parseTaskCount, parsePlanFiles) to increase parser.ts coverage from 66.56% to 80%+.

Purpose: These functions have zero test coverage and are preventing parser.ts from reaching 80% coverage target.

Output: New test cases covering readRoadmapPlans, parseTaskCount, and parsePlanFiles functions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-coverage/05-VERIFICATION.md
@.planning/phases/05-test-coverage/05-02-SUMMARY.md
@src/lib/parser.ts
@test/lib/parser.test.ts
</context>

<tasks>

<task type="auto">
  <name>Add tests for readRoadmapPlans function</name>
  <files>test/lib/parser.test.ts</files>
  <action>
    Add comprehensive test cases for readRoadmapPlans function (lines 346-381 in parser.ts).

    First, analyze the function in src/lib/parser.ts:
    1. Read lines 346-381 to understand readRoadmapPlans implementation
    2. Identify input parameters (roadmap file path)
    3. Identify output format (likely array of plan objects)
    4. Understand how it reads plan files from phase directories

    Create test fixture in test/lib/parser.test.ts:
    ```typescript
    describe('readRoadmapPlans', () => {
      test('reads plan files from phase directory', () => {
        // Create memfs structure:
        // .planning/phases/01-core-tui/01-01-PLAN.md
        // .planning/phases/01-core-tui/01-02-PLAN.md
        // Each PLAN.md has frontmatter (phase, plan, wave, depends_on, etc.)

        const plans = readRoadmapPlans('/.planning/phases/01-core-tui');

        expect(plans).toHaveLength(2);
        expect(plans[0]?.plan).toBe(1);
        expect(plans[1]?.plan).toBe(2);
      });

      test('handles missing plan files gracefully', () => {
        // Create phase directory with no PLAN.md files

        const plans = readRoadmapPlans('/.planning/phases/99-empty-phase');

        expect(plans).toEqual([]);
      });

      test('parses plan frontmatter correctly', () => {
        // PLAN.md with:
        // phase: 01-core-tui
        // plan: 1
        // wave: 1
        // depends_on: []

        const plans = readRoadmapPlans('/.planning/phases/01-core-tui');

        expect(plans[0]?.phase).toBe('01-core-tui');
        expect(plans[0]?.plan).toBe(1);
        expect(plans[0]?.wave).toBe(1);
        expect(plans[0]?.depends_on).toEqual([]);
      });
    });
    ```

    Use vol.fromJSON() to create memfs fixtures (pattern from 05-02-SUMMARY).
  </action>
  <verify>bun test test/lib/parser.test.ts -t "readRoadmapPlans"</verify>
  <done>All readRoadmapPlans tests pass, coverage of function increases</done>
</task>

<task type="auto">
  <name>Add tests for parseTaskCount function</name>
  <files>test/lib/parser.test.ts</files>
  <action>
    Add test cases for parseTaskCount function (lines 388-390 in parser.ts).

    First, analyze the function in src/lib/parser.ts:
    1. Read lines 388-390 to understand parseTaskCount implementation
    2. Identify input parameters (likely PLAN.md content or parsed plan object)
    3. Identify output format (likely task count number)
    4. Understand how it counts tasks from plan content

    Create test fixture in test/lib/parser.test.ts:
    ```typescript
    describe('parseTaskCount', () => {
      test('counts tasks from plan with multiple tasks', () => {
        // PLAN.md content with 3 tasks in <tasks> section

        const planContent = `
        ---
        phase: 01-core-tui
        plan: 1
        ---

        <tasks>
        <task type="auto">Task 1</task>
        <task type="auto">Task 2</task>
        <task type="auto">Task 3</task>
        </tasks>
        `;

        const taskCount = parseTaskCount(planContent);

        expect(taskCount).toBe(3);
      });

      test('handles plan with no tasks', () => {
        // PLAN.md content with empty <tasks> section

        const planContent = `
        ---
        phase: 01-core-tui
        plan: 1
        ---

        <tasks>
        </tasks>
        `;

        const taskCount = parseTaskCount(planContent);

        expect(taskCount).toBe(0);
      });

      test('handles plan with tasks having attributes', () => {
        // PLAN.md with tasks having type, files, action attributes

        const planContent = `
        <tasks>
        <task type="auto" files="src/app.tsx">Task 1</task>
        <task type="checkpoint:human-verify">Task 2</task>
        </tasks>
        `;

        const taskCount = parseTaskCount(planContent);

        expect(taskCount).toBe(2);
      });
    });
    ```

    Count <task> elements regardless of type (auto, checkpoint, etc.).
  </action>
  <verify>bun test test/lib/parser.test.ts -t "parseTaskCount"</verify>
  <done>All parseTaskCount tests pass, coverage of function increases</done>
</task>

<task type="auto">
  <name>Add tests for parsePlanFiles function</name>
  <files>test/lib/parser.test.ts</files>
  <action>
    Add test cases for parsePlanFiles function (lines 398-451 in parser.ts).

    First, analyze the function in src/lib/parser.ts:
    1. Read lines 398-451 to understand parsePlanFiles implementation
    2. Identify input parameters (likely roadmap content or phase number)
    3. Identify output format (likely list of plan file paths)
    4. Understand how it extracts plan file references from ROADMAP.md

    Create test fixture in test/lib/parser.test.ts:
    ```typescript
    describe('parsePlanFiles', () => {
      test('extracts plan file names from ROADMAP.md', () => {
        // ROADMAP.md content with:
        // Plans:
        // - [ ] 01-01-PLAN.md — Description
        // - [ ] 01-02-PLAN.md — Description

        const roadmapContent = `
        ### Phase 1: Core TUI
        **Plans**: 2 plans

        Plans:
        - [ ] 01-01-PLAN.md — Setup and tooling
        - [ ] 01-02-PLAN.md — Views and navigation
        `;

        const planFiles = parsePlanFiles(roadmapContent, 1);

        expect(planFiles).toEqual([
          '.planning/phases/01-core-tui/01-01-PLAN.md',
          '.planning/phases/01-core-tui/01-02-PLAN.md'
        ]);
      });

      test('handles phase with no plans', () => {
        // ROADMAP.md content with empty Plans section

        const roadmapContent = `
        ### Phase 99: Empty Phase
        **Plans**: 0 plans

        Plans:
        `;

        const planFiles = parsePlanFiles(roadmapContent, 99);

        expect(planFiles).toEqual([]);
      });

      test('filters by phase number correctly', () => {
        // ROADMAP.md with multiple phases, extract only specific phase plans

        const roadmapContent = `
        ### Phase 1: Core TUI
        Plans:
        - [ ] 01-01-PLAN.md — Phase 1 plan

        ### Phase 2: Real-time Updates
        Plans:
        - [ ] 02-01-PLAN.md — Phase 2 plan
        `;

        const phase1Plans = parsePlanFiles(roadmapContent, 1);
        const phase2Plans = parsePlanFiles(roadmapContent, 2);

        expect(phase1Plans).toHaveLength(1);
        expect(phase1Plans[0]).toContain('01-01-PLAN.md');
        expect(phase2Plans).toHaveLength(1);
        expect(phase2Plans[0]).toContain('02-01-PLAN.md');
      });

      test('handles plan files with different numbering (padded vs unpadded)', () => {
        // ROADMAP.md with plan names like 1-PLAN.md vs 01-PLAN.md

        const roadmapContent = `
        Plans:
        - [ ] 1-PLAN.md — Unpadded
        - [ ] 01-PLAN.md — Padded
        `;

        const planFiles = parsePlanFiles(roadmapContent, 1);

        expect(planFiles).toHaveLength(2);
        // Verify both formats are handled
      });
    });
    ```

    Use regex pattern that matches plan file formats from ROADMAP.md:
    - Extract "- [x] 01-01-PLAN.md" patterns
    - Handle both [x] and [ ] checkboxes
    - Extract just the filename, not description after "—"
  </action>
  <verify>bun test test/lib/parser.test.ts -t "parsePlanFiles"</verify>
  <done>All parsePlanFiles tests pass, coverage of function increases</done>
</task>

<task type="auto">
  <name>Verify parser.ts coverage reaches 80%+</name>
  <files></files>
  <action>
    Run parser tests with coverage to verify coverage increase from 66.56% to 80%+:

    ```bash
    bun test test/lib/parser.test.ts --coverage
    ```

    Check coverage report for src/lib/parser.ts:
    1. Verify line coverage >= 80%
    2. Verify readRoadmapPlans function covered (lines 346-381)
    3. Verify parseTaskCount function covered (lines 388-390)
    4. Verify parsePlanFiles function covered (lines 398-451)

    If coverage still below 80%:
    1. Identify which lines are still uncovered
    2. Determine if they're in these 3 functions or other functions
    3. Note in summary if more tests needed beyond these 3 functions

    Target is 80%+ for parser.ts (currently 66.56%).
  </action>
  <verify>bun test test/lib/parser.test.ts --coverage 2>&1 | grep -A 5 "src/lib/parser.ts"</verify>
  <done>parser.ts line coverage >= 80%, all 3 functions covered</done>
</task>

</tasks>

<verification>
After completion, verify:
1. bun test test/lib/parser.test.ts shows all new tests passing
2. Coverage report shows parser.ts at 80%+ line coverage
3. readRoadmapPlans, parseTaskCount, parsePlanFiles functions have tests
4. Total parser test count increased from 26 to 30+ tests
</verification>

<success_criteria>
- parser.ts line coverage increased from 66.56% to 80% or higher
- Test coverage for readRoadmapPlans function (previously 0%)
- Test coverage for parseTaskCount function (previously 0%)
- Test coverage for parsePlanFiles function (previously 0%)
- All new parser tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-13-SUMMARY.md`
</output>
