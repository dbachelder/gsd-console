---
phase: 05-test-coverage
plan: 11
type: execute
wave: 1
depends_on: []
files_modified: [test/hooks/useChangeHighlight.test.tsx]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All tests pass consistently (no flaky tests)"
    - "Bun test runner does not hang when running full test suite"
    - "useChangeHighlight tests verify timing behavior without React warnings"
  artifacts:
    - path: "test/hooks/useChangeHighlight.test.tsx"
      provides: "useChangeHighlight hook tests without setState-during-render"
      fixes: "markChanged() called outside render body (lines 84, 110)"
  key_links:
    - from: "test/hooks/useChangeHighlight.test.tsx"
      to: "bun test"
      via: "React warnings removed"
      pattern: "markChanged\\(\\).*(?!in render body)"
---

<objective>
Fix useChangeHighlight React warnings that cause Bun test runner to hang, unblocking full test suite execution.

Purpose: The test runner hangs when React warnings occur, preventing verification of all success criteria. This plan fixes the critical blocker first.

Output: Modified test file with markChanged() calls moved outside render body, eliminating setState-during-render warnings.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-coverage/05-VERIFICATION.md
@.planning/phases/05-test-coverage/05-06-SUMMARY.md
@src/hooks/useChangeHighlight.ts
@test/hooks/useChangeHighlight.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Fix useChangeHighlight tests to avoid setState during render</name>
  <files>test/hooks/useChangeHighlight.test.tsx</files>
  <action>
    The test file currently calls markChanged() inside the TestComponent render body at lines 84 and 110, which triggers React warning "Cannot update a component while rendering a different component" and causes Bun test runner to hang.

    Fix pattern from 05-06-SUMMARY is already established in test at lines 29-31:
    ```tsx
    // Call markChanged after render to avoid setState-during-render warning
    if (callMarkChanged) {
      callMarkChanged(['test-file.md']);
    }
    ```

    Apply this pattern to all tests that currently call markChanged() during render:

    1. Test "isFading returns true after hold duration passes" (lines 74-98):
       - Remove markChanged(['test-file.md']) from line 84 (inside render body)
       - Capture markChanged function via closure variable during render (like line 17)
       - Call markChanged AFTER render() call (outside component body)
       - Keep vi.advanceTimersByTime() inside render body (safe, doesn't trigger setState)

    2. Test "item removed after hold + fade duration" (lines 100-120+):
       - Remove markChanged(['test-file.md']) from line 110 (inside render body)
       - Capture markChanged function via closure variable during render
       - Call markChanged AFTER render() call (outside component body)
       - Keep vi.advanceTimersByTime() inside render body

    Pattern to apply:
    ```tsx
    // BEFORE (inside TestComponent render body - BAD):
    markChanged(['test-file.md']);

    // AFTER (outside render body - GOOD):
    let callMarkChanged: ((items: string[]) => void) | null = null;

    const TestComponent = () => {
      const { markChanged, ... } = useChangeHighlight({...});
      callMarkChanged = markChanged;
      // ... render logic ...
    };

    render(<TestComponent />);

    // Call after render (safe):
    if (callMarkChanged) {
      callMarkChanged(['test-file.md']);
    }
    ```

    Do NOT modify other aspects of tests - only move markChanged() calls outside render body.
  </action>
  <verify>bun test test/hooks/useChangeHighlight.test.tsx</verify>
  <done>All 6 useChangeHighlight tests pass without React warnings</done>
</task>

<task type="auto">
  <name>Verify full test suite runs without hanging</name>
  <files></files>
  <action>
    Run the full test suite to verify that removing React warnings from useChangeHighlight tests allows Bun test runner to complete without hanging.

    The fix in Task 1 should eliminate the "Cannot update a component while rendering a different component" warning that was causing the test runner to hang.

    Run full suite:
    ```bash
    bun test
    ```

    Expected outcome:
    - All test files run without hanging
    - Test runner completes and exits normally
    - No React warnings about setState during render
    - All passing tests from previous plans still pass

    If test suite still hangs, identify which test file causes the issue and note it for further investigation.
  </action>
  <verify>bun test 2>&1 | grep -E "(PASS|FAIL|tests passing|tests failing)" | tail -5</verify>
  <done>Full test suite completes without hanging, shows all test results</done>
</task>

</tasks>

<verification>
After completion, verify:
1. bun test test/hooks/useChangeHighlight.test.tsx passes all 6 tests
2. bun test (full suite) runs to completion without hanging
3. No React warnings in test output about setState during render
4. Test runner exits normally with summary of results
</verification>

<success_criteria>
- useChangeHighlight tests no longer call markChanged() during render
- All 6 useChangeHighlight tests pass
- Full test suite runs without hanging
- React warnings eliminated from test output
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-11-SUMMARY.md`
</output>
