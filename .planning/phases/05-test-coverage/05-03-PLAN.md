---
phase: 05-test-coverage
plan: 03
type: execute
wave: 3
depends_on: [05-01]
files_modified:
  - test/hooks/useVimNav.test.ts
  - test/hooks/useTabNav.test.ts
  - test/hooks/useToast.test.ts
  - test/hooks/useTabState.test.ts
autonomous: true
must_haves:
  truths:
    - "useVimNav tests pass (j/k navigation, gg/G jumps, Ctrl+d/u)"
    - "useTabNav tests pass (Tab and number key navigation)"
    - "useToast tests pass (add toast, auto-dismiss)"
    - "useTabState tests pass (state persistence across unmount/remount)"
  artifacts:
    - path: test/hooks/useVimNav.test.ts
      provides: "Vim navigation hook tests"
      min_lines: 80
    - path: test/hooks/useTabNav.test.ts
      provides: "Tab navigation hook tests"
      min_lines: 50
    - path: test/hooks/useToast.test.ts
      provides: "Toast notification hook tests"
      min_lines: 50
    - path: test/hooks/useTabState.test.ts
      provides: "Tab state persistence hook tests"
      min_lines: 50
  key_links:
    - from: test/hooks/useVimNav.test.ts
      to: src/hooks/useVimNav.ts
      via: "wrapper component render"
      pattern: "render\\(.*useVimNav"
---

<objective>
Add test coverage for core navigation and state hooks (useVimNav, useTabNav, useToast, useTabState) using ink-testing-library component wrapper pattern.

Purpose: These hooks are foundational for TUI interaction. They can't be tested directly in React, so use the component wrapper pattern from 05-RESEARCH.md Pattern 2. Tests verify state changes via ref updates and re-renders.

Output: Hook tests passing, navigation hooks covered, state persistence verified.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/05-test-coverage/05-RESEARCH.md
@src/hooks/useVimNav.ts
@src/hooks/useTabNav.ts
@src/hooks/useToast.ts
@src/hooks/useTabState.ts
@.planning/phases/05-test-coverage/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add useVimNav tests with component wrapper</name>
  <files>test/hooks/useVimNav.test.ts</files>
  <action>
    Create test/hooks/useVimNav.test.ts:

    Follow Pattern 2 from 05-RESEARCH.md - wrap hook in test component that updates a ref:

    ```typescript
    import { describe, expect, test, beforeEach, useRef } from 'bun:test';
    import { render } from 'ink-testing-library';
    import { useVimNav } from '../../src/hooks/useVimNav.ts';

    describe('useVimNav', () => {
      test('initializes with selectedIndex 0', () => {
        let capturedState: any = null;

        const TestComponent = () => {
          const nav = useVimNav({ itemCount: 5, pageSize: 10, isActive: true });
          capturedState = nav;
          return null;
        };

        render(<TestComponent />);

        expect(capturedState.selectedIndex).toBe(0);
      });

      test('moves down with j key', () => {
        const stateRef = useRef<any>(null);

        const TestComponent = () => {
          const nav = useVimNav({ itemCount: 5, pageSize: 10, isActive: true });
          stateRef.current = nav;
          return null;
        };

        const { stdin } = render(<TestComponent />);

        stdin.write('j');

        // Small delay for re-render (Pitfall 3 from research)
        await new Promise(resolve => setTimeout(resolve, 10));

        expect(stateRef.current?.selectedIndex).toBe(1);
      });

      // Add more tests:
      // - Moves up with k key
      // - Jumps to top with gg
      // - Jumps to bottom with G
      // - Scrolls down with Ctrl+d
      // - Scrolls up with Ctrl+u
      // - Respects itemCount boundary
      // - Handles pageSize correctly
    });
    ```

    Use useRef to capture state updates (Pitfall 3 - re-render timing).
    Simulate keyboard input via stdin.write() from ink-testing-library.
  </action>
  <verify>bun test test/hooks/useVimNav.test.ts</verify>
  <done>useVimNav tests pass (navigation keys, jumps, scrolling)</done>
</task>

<task type="auto">
  <name>Add useTabNav tests</name>
  <files>test/hooks/useTabNav.test.ts</files>
  <action>
    Create test/hooks/useTabNav.test.ts:

    Test cases:
    - Initializes with first tab selected
    - Cycles forward with Tab key (wraps around)
    - Cycles backward with Shift+Tab (wraps around)
    - Navigates to specific tab with number keys (1, 2, 3)
    - Respects tab count boundary

    Use same component wrapper pattern as useVimNav.
    Test via stdin.write() for Tab and key presses.
  </action>
  <verify>bun test test/hooks/useTabNav.test.ts</verify>
  <done>useTabNav tests pass (Tab, Shift+Tab, number keys)</done>
</task>

<task type="auto">
  <name>Add useToast tests</name>
  <files>test/hooks/useToast.test.ts</files>
  <action>
    Create test/hooks/useToast.test.ts:

    Test cases:
    - showToast adds toast to list
    - Multiple toasts render in order
    - Auto-dismiss after timeout (if implemented)
    - Dismiss by id removes specific toast
    - dismissAll clears all toasts

    Use component wrapper pattern, but since toasts are UI components, can also test via rendering actual Toast components with toast context.
  </action>
  <verify>bun test test/hooks/useToast.test.ts</verify>
  <done>useToast tests pass (add, dismiss, auto-dismiss)</done>
</task>

<task type="auto">
  <name>Add useTabState tests</name>
  <files>test/hooks/useTabState.test.ts</files>
  <action>
    Create test/hooks/useTabState.test.ts:

    Test cases (from CLAUDE.md "Avoiding Flicker" section):
    - Initialize state from props (new Set(initialProp))
    - State persists in ref (no re-renders on updates)
    - onSaveState called on unmount
    - State persists across unmount/remount cycle
    - Multiple tabs have independent state storage

    This is critical for avoiding re-render flicker - verify ref-based storage pattern.
  </action>
  <verify>bun test test/hooks/useTabState.test.ts</verify>
  <done>useTabState tests pass (persistence, ref storage, unmount save)</done>
</task>

</tasks>

<verification>
Run `bun test test/hooks/` - all hook tests must pass.
Run `bun test --coverage` - verify navigation hooks have >= 75% coverage.
</verification>

<success_criteria>
- useVimNav tests cover all keyboard actions (j/k/gg/G/Ctrl+d/u)
- useTabNav tests cover Tab/Shift+Tab/number keys
- useToast tests cover add/dismiss/auto-dismiss
- useTabState tests verify ref-based persistence pattern
- Hook coverage >= 75%
- All tests use component wrapper pattern (not direct hook calls)
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-03-SUMMARY.md`
</output>
