---
phase: 05-test-coverage
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - test/lib/parser.test.ts
  - test/fixtures/
autonomous: true
must_haves:
  truths:
    - "All parser tests pass (parseState, parseTodos, parseRoadmap)"
    - "Parser test coverage reaches 80% or higher"
    - "Tests use memfs vol.fromJSON for filesystem fixtures"
    - "Each test calls vol.reset() in beforeEach"
  artifacts:
    - path: test/lib/parser.test.ts
      provides: "Comprehensive parser function tests"
      min_lines: 200
    - path: test/fixtures/
      provides: "Sample planning documents for parser tests"
      contains: "roadmap.md"
  key_links:
    - from: test/lib/parser.test.ts
      to: test/fixtures/roadmap.md
      via: "vol.fromJSON fixture loading"
      pattern: "vol\\.fromJSON.*roadmap"
---

<objective>
Fix failing parser tests and add comprehensive test coverage for all parser functions using memfs filesystem mocks.

Purpose: Current parser tests are failing (parseTodos returns 11 instead of expected values). Need to fix tests and add full coverage for parseRoadmap, parseState, parseTodos, and helper functions. Tests must use memfs to avoid accessing real .planning/ directory.

Output: All parser tests passing, parser coverage >= 80%, fixture files for test data.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/05-test-coverage/05-RESEARCH.md
@src/lib/parser.ts
@.planning/phases/05-test-coverage/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Fix failing parser tests and add memfs usage</name>
  <files>test/lib/parser.test.ts</files>
  <action>
    Update test/lib/parser.test.ts:

    1. Import vol from memfs for filesystem mocking
    2. Add beforeEach hook with vol.reset() (follow Pitfall 2 from research)
    3. Fix parseTodos tests (currently failing - returning 11 instead of expected values)
    4. Add comprehensive tests for parseRoadmap covering all branches:
       - Extracts phase name, number, goal, dependsOn
       - Extracts requirements array
       - Extracts success criteria (numbered list)
       - Extracts plans total count
       - Handles decimal phases (e.g., 3.1)
       - Handles missing data gracefully
    5. Add tests for helper functions:
       - findPhaseDirectory (matches by number and name)
       - scanPhaseDirectory (checks for CONTEXT.md, PLAN.md, RESEARCH.md, UAT.md)
       - countCompletedPlans (counts SUMMARY files)
       - determinePhaseStatus (status logic based on progress)

    Follow Pattern 3 from 05-RESEARCH.md for filesystem mocking:
    - Use vol.fromJSON to populate test fixtures
    - Always call vol.reset() in beforeEach
    - Test behavior (outputs) not implementation (calls to fs)

    Fix parseTodos tests by understanding actual implementation - it may be parsing from STATE.md which has different structure.
  </action>
  <verify>bun test test/lib/parser.test.ts</verify>
  <done>All parser tests pass, parseRoadmap tests added with branch coverage</done>
</task>

<task type="auto">
  <name>Create fixture files for parser tests</name>
  <files>test/fixtures/roadmap.md</files>
  <action>
    Create test/fixtures/ directory with sample planning documents:

    1. test/fixtures/roadmap.md - Sample ROADMAP.md with 2-3 phases including:
       - Decimal phase (e.g., 03.1)
       - Phase with all sections (goal, dependsOn, requirements, successCriteria)
       - Phase with minimal data
       - Plan count in Plans section

    2. test/fixtures/state.md - Sample STATE.md with:
       - Current phase info
       - Progress percentage
       - Last activity

    3. test/fixtures/phases/01-core-tui/ - Sample phase directory with:
       - PLAN.md stub
       - SUMMARY.md (for testing countCompletedPlans)

    Use these fixtures in parser tests via vol.fromJSON() to populate memfs.
  </action>
  <verify>test -d test/fixtures && test -f test/fixtures/roadmap.md && test -f test/fixtures/state.md</verify>
  <done>Fixture files exist in test/fixtures/ for parser test data</done>
</task>

</tasks>

<verification>
Run `bun test test/lib/parser.test.ts` - all tests must pass.
Run `bun test --coverage` - src/lib/parser.ts coverage should be >= 80%.
Check coverage report: no uncovered branches in parseRoadmap helper functions.
</verification>

<success_criteria>
- All parser tests pass (no failures)
- parseRoadmap has tests for all major branches
- Helper functions tested (findPhaseDirectory, scanPhaseDirectory, countCompletedPlans, determinePhaseStatus)
- Fixture files created in test/fixtures/
- Parser coverage >= 80%
- Tests use vol.fromJSON and vol.reset() (memfs pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-02-SUMMARY.md`
</output>
