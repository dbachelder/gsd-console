---
phase: 05-test-coverage
plan: 12
type: execute
wave: 2
depends_on: [05-11]
files_modified: [test/lib/parser.test.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Parser functions have comprehensive test cases"
    - "All 26 parser tests pass"
    - "Parser regex patterns match ROADMAP.md format"
  artifacts:
    - path: "test/lib/parser.test.ts"
      provides: "Fixed parser tests with correct fixtures and regex"
      fixes: "Success criteria, plans count extraction tests now passing"
  key_links:
    - from: "test/lib/parser.test.ts"
      to: "src/lib/parser.ts"
      via: "Fixed regex patterns and test fixtures"
      pattern: "successCriteria|plansTotal"
---

<objective>
Fix 5 failing parser tests by correcting regex patterns and test fixtures to match actual ROADMAP.md format.

Purpose: Parser test failures are due to regex patterns not handling ROADMAP.md format with ** markers, and test fixtures not matching real document structure.

Output: All 26 parser tests passing with correct fixtures and regex patterns.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-coverage/05-VERIFICATION.md
@.planning/phases/05-test-coverage/05-02-SUMMARY.md
@src/lib/parser.ts
@test/lib/parser.test.ts
</context>

<tasks>

<task type="auto">
  <name>Identify and analyze 5 failing parser tests</name>
  <files></files>
  <action>
    Run parser tests to identify exactly which 5 tests are failing and why:

    ```bash
    bun test test/lib/parser.test.ts 2>&1 | grep -A 3 "FAIL\|Error:"
    ```

    Based on VERIFICATION.md, expected failures are:
    1. Success criteria extraction test (around line 154)
    2. Plans total count test (around line 170)
    3. Plans complete/total test (around lines 247-248)
    4. Phase status test (around line 273)
    5. One more parser-related test

    For each failing test, note:
    - Expected value
    - Actual value
    - Test name and line number
    - Which ROADMAP.md format feature it's testing

    Document these in a comment block at the top of the test file for reference during fixes.
  </action>
  <verify>grep -E "FAIL|Error:" test_results.txt (or verify manually if no file created)</verify>
  <done>All 5 failing tests identified with expected vs actual values</done>
</task>

<task type="auto">
  <name>Fix success criteria extraction regex pattern</name>
  <files>test/lib/parser.test.ts</files>
  <action>
    Based on VERIFICATION.md gap: "Tests have wrong fixtures (inline strings don't match ROADMAP.md format). Regex patterns don't handle ** markers."

    Check src/lib/parser.ts for success criteria extraction (around lines 56-63 based on VERIFICATION.md).

    Actual ROADMAP.md format for success criteria:
    ```markdown
    **Success Criteria** (what must be TRUE):
      1. User sees roadmap overview with phase list and progress percentage
      2. User can expand a phase to see its goal, requirements, and success criteria
    ```

    Key format features:
    - Header: "**Success Criteria**" (bold marker)
    - Numbered list: "  1. text" (indented, period after number)
    - Each criterion on separate line

    Fix test fixture to match this format:
    1. Add "**" markers to Success Criteria header
    2. Ensure numbered list format matches exactly (with period after number)
    3. Verify indentation matches ROADMAP.md (2 or 4 spaces before numbers)

    If regex pattern in parser.ts doesn't handle this:
    1. Update regex to match "/\\*\\*Success Criteria\\*\\*/" pattern
    2. Ensure regex handles optional parentheses after header: "(what must be TRUE):"
    3. Match numbered lines with "/^\\s+\\d+\\..*/" pattern

    Reference existing working tests (parseState, parseTodos have 100% coverage) for pattern guidance.
  </action>
  <verify>bun test test/lib/parser.test.ts -t "success criteria"</verify>
  <done>Success criteria extraction test passes</done>
</task>

<task type="auto">
  <name>Fix plans count extraction regex pattern</name>
  <files>test/lib/parser.test.ts</files>
  <action>
    Based on VERIFICATION.md gap: "Plans count extraction not working (tests expect '4 plans' but ROADMAP.md has bullet list)."

    Actual ROADMAP.md format for plans:
    ```markdown
    **Plans**: 4 plans

    Plans:
    - [x] 05-01-PLAN.md — Testing dependencies and memfs setup (Wave 1, 3 tasks)
    - [x] 05-02-PLAN.md — Parser tests and fixtures (Wave 2, 2 tasks)
    ```

    Key format features:
    - Summary line: "**Plans**: 4 plans" (bold marker + count)
    - Header: "Plans:"
    - Bullet list: "- [x] filename — description"
    - Checkboxes: "[x]" for completed, "[ ]" for pending

    Fix test fixture to match this format:
    1. Add "**" markers to Plans header
    2. Include summary line with count: "**Plans**: 4 plans"
    3. Use bullet list format (not numbered list)
    4. Include checkbox markers [x] or [ ]

    If regex pattern in parser.ts doesn't handle this:
    1. Update regex to match "/\\*\\*Plans\\*\\*:\\s*(\\d+)\\s+plans/" for count extraction
    2. Ensure regex handles bullet list items: "/^-\\s+\\[[x ]\\]\\s+([^—]+)/" for extracting plan names
    3. Count both [x] and [ ] for plansTotal
    4. Count only [x] for plansComplete

    Reference test at line 247-248 expecting plansComplete=2 and plansTotal=3 - this suggests counting completed vs pending plans.
  </action>
  <verify>bun test test/lib/parser.test.ts -t "plans count"</verify>
  <done>Plans count extraction tests pass (total and complete)</done>
</task>

<task type="auto">
  <name>Fix phase status extraction test</name>
  <files>test/lib/parser.test.ts</files>
  <action>
    Based on VERIFICATION.md gap: Phase status test failing (around line 273).

    Phase status depends on:
    - Plans: 4 plans, Plans: 3 plans, etc.
    - Checkboxes: [x] = completed, [ ] = pending
    - Status logic: If all plans [x], status = "complete", otherwise "in-progress"

    Check ROADMAP.md format for different phases:
    - Phase 1: All plans have [x] (complete)
    - Phase 5: Mix of [x] and [ ] (in-progress)

    Fix test fixture:
    1. Ensure Plans section has correct format with bold markers
    2. Set all checkboxes to [x] for "complete" phase
    3. Mix [x] and [ ] for "in-progress" phase
    4. Include "**Plans**: X plans" summary line

    Verify parser.ts status logic:
    - plansComplete == plansTotal → status = "complete"
    - Otherwise → status = "in-progress" (or other valid status values)

    Reference actual ROADMAP.md Phase 1 (all [x]) vs Phase 5 (mix) for expected values.
  </action>
  <verify>bun test test/lib/parser.test.ts -t "status"</verify>
  <done>Phase status extraction test passes</done>
</task>

<task type="auto">
  <name>Verify all 26 parser tests pass</name>
  <files></files>
  <action>
    Run full parser test suite to verify all 5 previously failing tests now pass:

    ```bash
    bun test test/lib/parser.test.ts
    ```

    Expected outcome:
    - All 26 tests passing
    - 0 tests failing
    - No new test failures introduced

    If any tests still fail:
    1. Identify which test and why
    2. Check if fixture format matches ROADMAP.md
    3. Check if regex pattern handles ROADMAP.md format features
    4. Repeat Task 2-4 pattern analysis for remaining failures

    This is final verification that regex patterns and fixtures are corrected.
  </action>
  <verify>bun test test/lib/parser.test.ts 2>&1 | grep -E "(\\d+ passing|\\d+ failing)"</verify>
  <done>All 26 parser tests passing, 0 failing</done>
</task>

</tasks>

<verification>
After completion, verify:
1. bun test test/lib/parser.test.ts shows 26 passing, 0 failing
2. Test fixtures match ROADMAP.md format (bold markers, numbered lists, bullet lists)
3. Regex patterns in parser.ts correctly handle ROADMAP.md format
4. Success criteria, plans count, and phase status tests all pass
</verification>

<success_criteria>
- All 26 parser tests pass (up from 21 passing)
- Test fixtures use correct ROADMAP.md format with ** markers
- Regex patterns handle success criteria, plans count, and phase status extraction
- Parser test pass rate at 100%
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-12-SUMMARY.md`
</output>
