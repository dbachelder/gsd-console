---
phase: 05-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - test/setup.ts
  - bunfig.toml
autonomous: true
must_haves:
  truths:
    - "bun add -D ink-testing-library memfs installs without errors"
    - "test/setup.ts exists with memfs filesystem mocks configured"
    - "bunfig.toml has preload script configured for test setup"
  artifacts:
    - path: package.json
      provides: "Testing dependencies (ink-testing-library, memfs)"
      contains: "ink-testing-library"
    - path: test/setup.ts
      provides: "Memfs filesystem mocks for all tests"
      exports: ["memfs", "vol"]
    - path: bunfig.toml
      provides: "Test preload configuration"
      contains: "preload"
  key_links:
    - from: bunfig.toml
      to: test/setup.ts
      via: "preload configuration"
      pattern: "preload.*=.*test/setup\\.ts"
---

<objective>
Install testing dependencies and configure memfs filesystem mocks to enable isolated testing without accessing real .planning/ directory.

Purpose: ink-testing-library is required for rendering Ink components in tests; memfs is required for mocking filesystem operations so tests don't touch real planning files. Configuring preload ensures mocks are available before any code imports.

Output: Testing dependencies installed, memfs mocks configured via preload script, bunfig.toml updated.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/05-test-coverage/05-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Install testing dependencies</name>
  <files>package.json</files>
  <action>
    Run: `bun add -D ink-testing-library memfs`

    These are the standard testing libraries identified in 05-RESEARCH.md:
    - ink-testing-library: For rendering Ink components and asserting on terminal output
    - memfs: For mocking filesystem operations so tests don't touch real .planning/ files
  </action>
  <verify>cat package.json | grep -E "ink-testing-library|memfs" | wc -l | xargs test 2 -eq</verify>
  <done>Both ink-testing-library and memfs installed as devDependencies</done>
</task>

<task type="auto">
  <name>Create test setup with memfs mocks</name>
  <files>test/setup.ts</files>
  <action>
    Create test/setup.ts with memfs filesystem mocks:

    ```typescript
    import { mock } from 'bun:test';
    import { fs } from 'memfs';

    // Configure memfs to mock all node:fs and node:fs/promises operations
    // This ensures tests use in-memory filesystem instead of real .planning/ directory
    mock.module('node:fs', () => fs);
    mock.module('node:fs/promises', () => fs.promises);

    // Export vol (volume) for tests to populate with test fixtures
    export { vol } from 'memfs';
    ```

    Follow Pattern 1 and Pitfall 1 from 05-RESEARCH.md:
    - Preload configures mocks before any modules are imported
    - Use vol.fromJSON in tests to populate filesystem with fixtures
    - Always call vol.reset() in beforeEach to avoid test pollution
  </action>
  <verify>test -f test/setup.ts && cat test/setup.ts | grep -E "mock.module|memfs" | wc -l | xargs test 3 -ge</verify>
  <done>test/setup.ts exists with memfs mocks for node:fs and node:fs/promises</done>
</task>

<task type="auto">
  <name>Configure bunfig.toml preload script</name>
  <files>bunfig.toml</files>
  <action>
    Update bunfig.toml [test] section to include preload:

    ```toml
    [test]
    coverage = true
    coverageThreshold = 0.8
    coverageReporter = ["text", "lcov"]
    coverageDir = "coverage"
    coverageSkipTestFiles = true
    preload = ["./test/setup.ts"]
    ```

    This ensures test/setup.ts runs before any test modules are loaded, allowing mocks to be configured before code imports node:fs.
  </action>
  <verify>cat bunfig.toml | grep "preload.*test/setup.ts" | wc -l | xargs test 1 -eq</verify>
  <done>bunfig.toml has preload configured for test/setup.ts</done>
</task>

</tasks>

<verification>
Run `bun test` - test setup should load without errors.
Run `bun test --coverage` - coverage should initialize (0% is expected at this point).
</verification>

<success_criteria>
- ink-testing-library and memfs installed as devDependencies
- test/setup.ts exists with memfs mocks configured
- bunfig.toml preload points to test/setup.ts
- bun test runs without preload errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-01-SUMMARY.md`
</output>
