---
phase: 03-actions-and-editing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/palette/CommandPalette.tsx
  - src/components/picker/FilePicker.tsx
  - src/components/roadmap/RoadmapView.tsx
  - src/components/layout/TabLayout.tsx
  - src/hooks/useExternalEditor.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Command palette overlay is clearly readable with solid background"
    - "File picker overlay is clearly readable with solid background"
    - "File picker shows phase-specific files when pressing e on Roadmap tab"
  artifacts:
    - path: "src/components/palette/CommandPalette.tsx"
      provides: "Solid background overlay"
      contains: "backgroundColor"
    - path: "src/components/picker/FilePicker.tsx"
      provides: "Solid background overlay"
      contains: "backgroundColor"
    - path: "src/components/roadmap/RoadmapView.tsx"
      provides: "Phase navigation callback"
      contains: "onPhaseNavigate"
    - path: "src/hooks/useExternalEditor.ts"
      provides: "Phase-aware file selection on roadmap tab"
      contains: "findPhaseDir"
  key_links:
    - from: "src/components/roadmap/RoadmapView.tsx"
      to: "src/components/layout/TabLayout.tsx"
      via: "onPhaseNavigate prop"
      pattern: "onPhaseNavigate.*selectedIndex"
    - from: "src/components/layout/TabLayout.tsx"
      to: "src/app.tsx"
      via: "onPhaseSelect callback"
      pattern: "onPhaseSelect.*onPhaseNavigate"
---

<objective>
Close 2 UAT gaps from Phase 03:

1. **Cosmetic (Test 1):** Overlay transparency - Add solid black backgrounds to CommandPalette and FilePicker so they are clearly readable over TUI content.

2. **Major (Test 9):** Editor context on Roadmap - When user presses `e` on Roadmap tab, show phase-specific files based on which phase is selected (via j/k navigation), not just ROADMAP.md.

Purpose: Fix usability issues identified during UAT testing.
Output: Working overlays with solid backgrounds; context-aware editor on Roadmap tab.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-actions-and-editing/03-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add solid background to overlay components</name>
  <files>
    src/components/palette/CommandPalette.tsx
    src/components/picker/FilePicker.tsx
  </files>
  <action>
Add backgroundColor property to the outer Box component in both overlay files:

**CommandPalette.tsx (line 64):**
Change:
```tsx
<Box flexDirection="column" borderStyle="round" borderColor="blue" paddingX={1}>
```
To:
```tsx
<Box flexDirection="column" borderStyle="round" borderColor="blue" paddingX={1} backgroundColor="black">
```

**FilePicker.tsx (line 51):**
Change:
```tsx
<Box flexDirection="column" borderStyle="round" borderColor="cyan" paddingX={2} paddingY={1}>
```
To:
```tsx
<Box flexDirection="column" borderStyle="round" borderColor="cyan" paddingX={2} paddingY={1} backgroundColor="black">
```
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Visual verification deferred to UAT re-test.
  </verify>
  <done>
Both overlays have solid black backgrounds that prevent transparency issues.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire phase navigation from RoadmapView to App state</name>
  <files>
    src/components/roadmap/RoadmapView.tsx
    src/components/layout/TabLayout.tsx
  </files>
  <action>
**RoadmapView.tsx:**

1. Add `onPhaseNavigate` prop to interface (around line 16):
```tsx
onPhaseNavigate?: (phaseNumber: number) => void;
```

2. Destructure it in the component (around line 28):
```tsx
onPhaseNavigate,
```

3. Add useEffect after the useVimNav hook (around line 82) to fire callback when selectedIndex changes:
```tsx
// Notify parent of phase navigation for editor context
useEffect(() => {
  const phase = phases[selectedIndex];
  if (phase) {
    onPhaseNavigate?.(phase.number);
  }
}, [selectedIndex, phases, onPhaseNavigate]);
```

**TabLayout.tsx:**

1. Pass the new callback to RoadmapView in both places it's rendered (lines 77-84 and 117-124):
```tsx
<RoadmapView
  phases={data.phases}
  isActive={isActive}
  onSelectPhase={handleSelectPhase}
  onPhaseNavigate={onPhaseSelect}  // ADD THIS LINE
  isPhaseHighlighted={isPhaseHighlighted}
  isPhaseFading={isPhaseFading}
  showToast={showToast}
/>
```
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Manual test: Navigate j/k on Roadmap tab, then check that pressing `e` opens file picker with phase files (not just ROADMAP.md).
  </verify>
  <done>
RoadmapView fires onPhaseNavigate callback on j/k navigation; App state tracks currently selected phase on Roadmap tab.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update getEditableFiles to use phase context on Roadmap tab</name>
  <files>
    src/hooks/useExternalEditor.ts
  </files>
  <action>
Modify the `case 'roadmap'` block (lines 52-56) to check for selectedPhase and return phase-specific files:

**Replace lines 52-56:**
```tsx
case 'roadmap': {
  // Roadmap tab: ROADMAP.md
  const roadmapPath = join(planningDir, 'ROADMAP.md');
  return existsSync(roadmapPath) ? [roadmapPath] : [];
}
```

**With:**
```tsx
case 'roadmap': {
  // If a phase is selected, offer phase files AND roadmap
  if (selectedPhase !== undefined) {
    const phaseDir = findPhaseDir(planningDir, selectedPhase);
    if (phaseDir) {
      // Build list of phase files
      const paddedNum = String(selectedPhase).padStart(2, '0');
      const planPattern = new RegExp(`^${paddedNum}-\\d{2}-PLAN\\.md$`);

      const files = readdirSync(phaseDir);
      const editableFiles: string[] = [];

      // Add phase-specific plan files (like 03-01-PLAN.md)
      for (const file of files) {
        if (planPattern.test(file)) {
          editableFiles.push(join(phaseDir, file));
        }
      }

      // Add common phase files
      const candidates = [
        `${paddedNum}-CONTEXT.md`,
        `${paddedNum}-RESEARCH.md`,
        `${paddedNum}-SUMMARY.md`,
        `${paddedNum}-UAT.md`,
        `${paddedNum}-VERIFICATION.md`,
      ];

      for (const candidate of candidates) {
        const filePath = join(phaseDir, candidate);
        if (existsSync(filePath) && !editableFiles.includes(filePath)) {
          editableFiles.push(filePath);
        }
      }

      // Also add ROADMAP.md as last option
      const roadmapPath = join(planningDir, 'ROADMAP.md');
      if (existsSync(roadmapPath)) {
        editableFiles.push(roadmapPath);
      }

      return editableFiles;
    }
  }

  // Fallback: just ROADMAP.md
  const roadmapPath = join(planningDir, 'ROADMAP.md');
  return existsSync(roadmapPath) ? [roadmapPath] : [];
}
```
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Run `npm run dev`, navigate to a phase on Roadmap tab using j/k, press `e`. File picker should show phase files (PLAN, CONTEXT, etc.) plus ROADMAP.md at the end.
  </verify>
  <done>
Pressing `e` on Roadmap tab with a phase selected shows file picker with that phase's files, not just ROADMAP.md.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. `npm run dev` starts TUI successfully
3. Press `:` - command palette has solid black background (not transparent)
4. Navigate to a phase with j/k, press `e` - file picker has solid black background
5. File picker shows phase files (CONTEXT, PLAN, UAT, etc.) plus ROADMAP.md
6. Select a phase file from picker, editor opens correct file
</verification>

<success_criteria>
- Both gaps from 03-UAT.md are resolved
- Overlays are clearly readable (backgroundColor="black")
- Editor on Roadmap tab is phase-context-aware
- All TypeScript/build checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-actions-and-editing/03-04-SUMMARY.md`
</output>
