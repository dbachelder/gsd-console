---
phase: 03-actions-and-editing
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/hooks/useExternalEditor.ts
  - src/components/picker/FilePicker.tsx
  - src/components/layout/HelpOverlay.tsx
  - src/components/layout/Footer.tsx
  - src/components/layout/TabLayout.tsx
  - src/app.tsx
autonomous: true

must_haves:
  truths:
    - "User can press e to open current file in $EDITOR"
    - "User sees file picker when multiple files exist for selection"
    - "TUI resumes cleanly after editor exits"
    - "User sees updated help overlay with new keybindings"
    - "Footer shows cleaner hints without 1/2/3 jump keys"
  artifacts:
    - path: "src/hooks/useExternalEditor.ts"
      provides: "Editor spawning with alternate screen handling"
      exports: ["useExternalEditor"]
    - path: "src/components/picker/FilePicker.tsx"
      provides: "File selection overlay for multi-file editing"
      exports: ["FilePicker"]
    - path: "src/components/layout/HelpOverlay.tsx"
      provides: "Updated help with new keybindings"
      contains: "':' - Command palette"
    - path: "src/components/layout/Footer.tsx"
      provides: "Cleaner footer with arrow hints"
      contains: "up/down arrows"
  key_links:
    - from: "src/app.tsx"
      to: "src/hooks/useExternalEditor.ts"
      via: "e key handler"
      pattern: "openEditor"
    - from: "src/hooks/useExternalEditor.ts"
      to: "child_process"
      via: "spawnSync"
      pattern: "spawnSync.*stdio.*inherit"
---

<objective>
Implement external editor integration and update help/footer UI.

Purpose: Let users edit planning files in their preferred editor without leaving TUI context, and improve keyboard hint clarity.
Output: `e` key opens current context in $EDITOR, help overlay documents all new shortcuts, footer shows cleaner navigation hints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-actions-and-editing/03-CONTEXT.md
@.planning/phases/03-actions-and-editing/03-RESEARCH.md

# Prior plan context
@.planning/phases/03-actions-and-editing/03-01-SUMMARY.md

# Existing code
@src/app.tsx
@src/components/layout/TabLayout.tsx
@src/components/layout/HelpOverlay.tsx
@src/components/layout/Footer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create external editor hook with file picker</name>
  <files>src/hooks/useExternalEditor.ts, src/components/picker/FilePicker.tsx</files>
  <action>
1. Create `src/hooks/useExternalEditor.ts`:
   - Export function `openInEditor(filePath: string): boolean`
     - Get editor from `process.env.EDITOR || process.env.VISUAL || 'vim'`
     - Exit alternate screen: `process.stdout.write('\x1b[?1049l')`
     - Use `spawnSync(editor, [filePath], { stdio: 'inherit' })`
     - Re-enter alternate screen: `process.stdout.write('\x1b[?1049h')`
     - Return true if status === 0

   - Export function `getEditableFiles(context: EditContext): string[]`
     - EditContext: `{ activeTab: string, selectedPhase?: number, selectedTodo?: string, planningDir: string }`
     - For roadmap tab: return ROADMAP.md path
     - For phase tab with selected phase:
       - Build phase dir path (e.g., .planning/phases/01-xxx/)
       - Check for PLAN.md, CONTEXT.md, RESEARCH.md
       - Return array of existing files
     - For todos tab with selected todo: return todo file path
     - If no selection: return empty array

   - Export hook `useExternalEditor(context: EditContext)`
     - Returns `{ files: string[], open: (path?: string) => void, needsPicker: boolean }`
     - needsPicker = files.length > 1
     - open() with no arg opens first file, with arg opens specific file

2. Create `src/components/picker/FilePicker.tsx`:
   - Simple overlay showing numbered list of files
   - Props: files, onSelect, onClose
   - User presses 1/2/3 to select file, Escape to cancel
   - Use Box with border, Text for each file with number prefix
  </action>
  <verify>
    - `bun run typecheck` passes
    - Hook exports correctly
    - FilePicker component renders file list
  </verify>
  <done>External editor hook ready to spawn $EDITOR, file picker UI for multi-file selection</done>
</task>

<task type="auto">
  <name>Task 2: Update HelpOverlay with new keybindings</name>
  <files>src/components/layout/HelpOverlay.tsx</files>
  <action>
1. Read current HelpOverlay.tsx structure

2. Add new keybinding sections:
   - Under Global: add `:` - Command palette
   - Under Global: add `e` - Open in editor
   - Update existing entries if needed

3. Organize keybindings into logical groups:
   - Navigation: j/k, gg/G, Ctrl+d/u, Tab, Enter
   - Actions: `:` (command palette), `e` (editor), `d` (detail toggle)
   - Display: `?` (help), `q` (quit)

4. Remove or update any outdated references to 1/2/3 for tab switching if mentioned
  </action>
  <verify>
    - `bun run typecheck` passes
    - Help overlay shows `:` and `e` keybindings
  </verify>
  <done>Help overlay documents command palette and editor keybindings</done>
</task>

<task type="auto">
  <name>Task 3: Lift selection state and wire editor to App</name>
  <files>src/components/layout/TabLayout.tsx, src/components/layout/Footer.tsx, src/app.tsx</files>
  <action>
**Selection State Architecture:**

Currently `selectedPhaseNumber` lives in TabLayout.tsx (line 40). To enable the editor feature, lift this state to App.tsx:

1. **Update `src/components/layout/TabLayout.tsx`:**
   - Remove internal `selectedPhaseNumber` state
   - Add new props to TabLayoutProps:
     ```typescript
     selectedPhaseNumber: number;
     onPhaseSelect: (phaseNumber: number) => void;
     selectedTodoId?: string;
     onTodoSelect?: (todoId: string) => void;
     ```
   - Replace `setSelectedPhaseNumber` calls with `onPhaseSelect`
   - Pass `onTodoSelect` to TodosView (if TodosView supports it, otherwise add prop there too)

2. **Update `src/app.tsx`:**
   - Add selection state at App level:
     ```typescript
     const [selectedPhaseNumber, setSelectedPhaseNumber] = useState<number>(flags.phase ?? 1);
     const [selectedTodoId, setSelectedTodoId] = useState<string | undefined>();
     ```
   - Pass to TabLayout: `selectedPhaseNumber`, `onPhaseSelect={setSelectedPhaseNumber}`, etc.
   - Import useExternalEditor, FilePicker
   - Create editor context from lifted state:
     ```typescript
     const editorContext = {
       activeTab,
       selectedPhase: selectedPhaseNumber,
       selectedTodo: selectedTodoId,
       planningDir,
     };
     const { files, open, needsPicker } = useExternalEditor(editorContext);
     ```
   - Add state for file picker visibility: `const [showFilePicker, setShowFilePicker] = useState(false)`
   - Add `e` key handler in useInput:
     - If files.length === 0: show toast "No file to edit" (or log)
     - If files.length === 1: call open() directly
     - If files.length > 1: setShowFilePicker(true)
   - Render FilePicker when showFilePicker is true:
     ```typescript
     {showFilePicker && (
       <FilePicker
         files={files}
         onSelect={(path) => { open(path); setShowFilePicker(false); }}
         onClose={() => setShowFilePicker(false)}
       />
     )}
     ```
   - File watcher will auto-refresh after edit

3. **Update `src/components/layout/Footer.tsx`:**
   - Remove 1/2/3 tab jump hints from all views
   - Use up/down arrows (or arrow symbols) instead of j/k
   - Keep essential hints only: navigation, Tab for tabs, ? for help, q for quit
   - Add `:` for command palette hint
   - Add `e` for editor hint when appropriate
   - Keep hints concise - one line
  </action>
  <verify>
    - `bun run typecheck` passes
    - `bun run lint` passes
    - Footer shows cleaner hints without 1/2/3
    - Press `e` on roadmap tab opens ROADMAP.md in editor
    - Press `e` on phase tab with selection shows picker if multiple files exist
    - After editor exits, TUI resumes and file watcher refreshes data
  </verify>
  <done>Selection state lifted to App.tsx, external editor integration working with `e` key, footer cleaned up</done>
</task>

</tasks>

<verification>
Run `bun run dev` in the gsd-tui directory:
1. On Roadmap tab, press `e` - should open ROADMAP.md in $EDITOR
2. Exit editor - TUI should resume cleanly
3. Navigate to a phase with multiple files (PLAN.md, CONTEXT.md)
4. Press `e` - should show file picker
5. Press 1 or 2 - should open selected file in editor
6. Press `?` - help overlay should show `:` and `e` keybindings
7. Footer should show arrow symbols for navigation, not j/k
8. Footer should not show 1/2/3 for tab jumping
</verification>

<success_criteria>
- [x] `e` key opens file in $EDITOR
- [x] Editor spawns with full terminal control (stdio: inherit)
- [x] TUI resumes after editor exits (alternate screen handling)
- [x] File picker appears when multiple files available
- [x] Help overlay documents `:` and `e` keybindings
- [x] Footer uses arrows instead of j/k for navigation hints
- [x] Footer does not show 1/2/3 tab jump hints
- [x] If $EDITOR not set, falls back to vim
- [x] `bun run typecheck` passes
- [x] `bun run lint` passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-actions-and-editing/03-02-SUMMARY.md`
</output>
