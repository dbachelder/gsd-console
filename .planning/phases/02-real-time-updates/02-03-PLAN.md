---
phase: 02-real-time-updates
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app.tsx
  - src/hooks/useGsdData.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Spinner only shows during file refresh, stops after debounce completes"
    - "TUI displays without flicker during normal operation"
    - "Editing a specific todo highlights only that todo"
    - "ROADMAP.md edits highlight all phases (conservative behavior documented)"
  artifacts:
    - path: "src/app.tsx"
      provides: "Stable onError callback and granular todo highlighting"
    - path: "src/hooks/useGsdData.ts"
      provides: "Stable dependency array without changedFiles"
  key_links:
    - from: "src/app.tsx"
      to: "useFileWatcher"
      via: "useCallback-wrapped onError"
      pattern: "useCallback.*onError"
---

<objective>
Fix 4 UAT issues related to React hook stability and highlight granularity.

Purpose: The TUI has render loops (spinner always running, flicker) and overly broad highlights (all phases, all todos). These stem from unstable callback references and incorrect dependency arrays.

Output: Stable TUI with correct highlight behavior per the original phase success criteria.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-real-time-updates/02-UAT.md
@src/app.tsx
@src/hooks/useFileWatcher.ts
@src/hooks/useGsdData.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stabilize onError callback reference</name>
  <files>src/app.tsx</files>
  <action>
Wrap the onError callback in useCallback to prevent new function reference on each render.

Current (line 62):
```tsx
onError: (err) => console.error('File watcher error:', err),
```

Change to:
```tsx
// Before the useFileWatcher call, add:
const handleWatcherError = useCallback((err: Error) => {
  console.error('File watcher error:', err);
}, []);

// Then use in options:
onError: handleWatcherError,
```

This prevents useFileWatcher's useEffect from re-running on every App render, which was clearing the debounce timer before setIsRefreshing(false) could execute.
  </action>
  <verify>
Run `bun run build` to verify no TypeScript errors.
Run the TUI (`bun run dev`) and confirm the spinner is NOT constantly spinning when no files are changing.
  </verify>
  <done>Spinner appears only during actual file changes and stops after debounce period.</done>
</task>

<task type="auto">
  <name>Task 2: Remove changedFiles from useGsdData dependency array</name>
  <files>src/hooks/useGsdData.ts</files>
  <action>
Remove `changedFiles` from the useEffect dependency array on line 127. The changedFiles array is recreated on each file change with a new reference, causing the effect to re-run and setData() to be called, triggering a render loop.

Current (line 127):
```tsx
}, [planningDir, refreshTrigger, changedFiles]);
```

Change to:
```tsx
}, [planningDir, refreshTrigger]);
```

Also update line 115 to use a ref for changedFiles instead of the prop:
- Add `useRef` import
- Create `const changedFilesRef = useRef<string[]>([]);` at hook top
- Before `setData()`, add `changedFilesRef.current = changedFiles;`
- In setData, use `changedFiles: changedFilesRef.current`

This ensures the data object has changedFiles for downstream use without causing re-renders.
  </action>
  <verify>
Run `bun run dev`, navigate around the TUI. Confirm no visible flicker during normal operation (no file changes happening).
  </verify>
  <done>TUI renders stably without flicker when files are not changing.</done>
</task>

<task type="auto">
  <name>Task 3: Fix todo highlighting to be file-specific</name>
  <files>src/app.tsx</files>
  <action>
Update deriveAffectedItemIds (lines 43-47) to extract the specific todo ID from the file path instead of marking all todos.

Current:
```tsx
// STATE.md or todos/*.md affects todos
if (file.includes('STATE.md') || file.includes('todos/')) {
  for (const t of data.todos) {
    ids.push(`todo-${t.id}`);
  }
}
```

Change to:
```tsx
// STATE.md affects all todos (can't know which changed)
if (file.includes('STATE.md')) {
  for (const t of data.todos) {
    ids.push(`todo-${t.id}`);
  }
}

// Individual todo file: extract filename and construct specific ID
// Files are like "todos/pending/some-task.md" -> id is "pending-some-task"
// Or "todos/done/completed-task.md" -> id is "done-completed-task"
const todoMatch = /todos\/(pending|done)\/(.+)\.md$/.exec(file);
if (todoMatch) {
  const status = todoMatch[1]; // 'pending' or 'done'
  const name = todoMatch[2];   // filename without extension
  ids.push(`todo-${status}-${name}`);
}
```

This extracts the specific todo from the path rather than highlighting all todos.
  </action>
  <verify>
Run `bun run dev`. Edit a todo file in .planning/todos/pending/. Confirm only that specific todo highlights yellow, not all todos.
  </verify>
  <done>Editing one todo file highlights only that specific todo.</done>
</task>

<task type="auto">
  <name>Task 4: Document ROADMAP.md conservative highlighting behavior</name>
  <files>src/app.tsx</files>
  <action>
Add a comment explaining the conservative behavior for ROADMAP.md changes. This is intentional - we cannot parse markdown diffs to determine which phase changed, so we highlight all phases as a safe signal that "something changed in the roadmap."

Update lines 30-35 with a clear comment:
```tsx
// ROADMAP.md affects all phases - conservative behavior
// We cannot diff markdown content to identify which specific phase changed,
// so we highlight all phases to signal "roadmap changed, check phases"
if (file.includes('ROADMAP.md')) {
  for (const p of data.phases) {
    ids.push(`phase-${p.number}`);
  }
}
```

This documents the intentional behavior rather than treating it as a bug.
  </action>
  <verify>
Read the comment in the code to confirm it explains the behavior.
Optionally: edit ROADMAP.md and confirm all phases highlight (expected conservative behavior).
  </verify>
  <done>ROADMAP.md all-phases highlighting is documented as intentional conservative behavior.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with no TypeScript errors
2. `bun run dev` starts without errors
3. Spinner appears only during file changes, stops after debounce
4. No flicker during normal operation
5. Editing a specific todo highlights only that todo
6. ROADMAP.md edits highlight all phases (documented as intentional)
</verification>

<success_criteria>
All 4 UAT issues resolved:
- Spinner runs only during refresh operations
- No flicker during normal TUI operation
- Todo highlighting is granular per-file
- ROADMAP.md behavior documented as conservative (acceptable)
</success_criteria>

<output>
After completion, create `.planning/phases/02-real-time-updates/02-03-SUMMARY.md`
</output>
