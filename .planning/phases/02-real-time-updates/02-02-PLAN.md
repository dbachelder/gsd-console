---
phase: 02-real-time-updates
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/layout/Header.tsx
  - src/components/roadmap/PhaseRow.tsx
  - src/components/todos/TodoItem.tsx
  - src/app.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Spinner appears in header during file refresh"
    - "Recently changed phases show background highlight"
    - "Recently changed todos show background highlight"
    - "Highlight fades after 5 seconds"
    - "Navigation state preserved across refreshes"
  artifacts:
    - path: "src/components/layout/Header.tsx"
      provides: "Refresh spinner indicator"
      contains: "Spinner"
    - path: "src/components/roadmap/PhaseRow.tsx"
      provides: "Highlight support for changed phases"
      contains: "backgroundColor"
    - path: "src/components/todos/TodoItem.tsx"
      provides: "Highlight support for changed todos"
      contains: "backgroundColor"
    - path: "src/app.tsx"
      provides: "Wiring of file watcher, data loading, and highlights"
      contains: "useFileWatcher"
  key_links:
    - from: "src/app.tsx"
      to: "useFileWatcher"
      via: "hook import and usage"
      pattern: "useFileWatcher"
    - from: "src/app.tsx"
      to: "useChangeHighlight"
      via: "hook import and usage"
      pattern: "useChangeHighlight"
    - from: "src/components/roadmap/PhaseRow.tsx"
      to: "isHighlighted prop"
      via: "backgroundColor conditional"
      pattern: "isHighlighted.*backgroundColor"
---

<objective>
Wire the file watcher and change highlights into the UI components.

Purpose: Connect the reactive infrastructure to visible UI elements so users see automatic refreshes and change indicators.
Output: Header shows spinner during refresh, phases and todos show highlight when changed, all wired through App.tsx.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-real-time-updates/02-CONTEXT.md
@.planning/phases/02-real-time-updates/02-RESEARCH.md
@.planning/phases/02-real-time-updates/02-01-SUMMARY.md
@src/app.tsx
@src/components/layout/Header.tsx
@src/components/roadmap/PhaseRow.tsx
@src/components/todos/TodoItem.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add refresh spinner to Header</name>
  <files>src/components/layout/Header.tsx</files>
  <action>
Add a spinner indicator that appears when isRefreshing is true.

Changes to Header.tsx:
1. Add `isRefreshing?: boolean` to HeaderProps interface
2. Import Spinner from '@inkjs/ui' (already used in app.tsx loading state)
3. Add spinner next to "GSD Status" title when isRefreshing is true

Update the title row to show spinner:
```tsx
<Box>
  <Text bold color="cyan">GSD Status</Text>
  {isRefreshing && (
    <Box marginLeft={1}>
      <Spinner label="" />
    </Box>
  )}
</Box>
```

Keep the existing layout - just add the spinner inline with the title.
  </action>
  <verify>
TypeScript compiles: `bunx tsc --noEmit`
Header accepts isRefreshing prop
  </verify>
  <done>
Header shows a spinner next to title when isRefreshing is true.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add highlight support to PhaseRow and TodoItem</name>
  <files>src/components/roadmap/PhaseRow.tsx, src/components/todos/TodoItem.tsx</files>
  <action>
Add isHighlighted and isFading props to show background color for recently changed items.

Changes to PhaseRow.tsx:
1. Add to PhaseRowProps:
   - `isHighlighted?: boolean`
   - `isFading?: boolean`
2. Calculate background color:
   - If isHighlighted and not isFading: use dim yellow '#3d3d00'
   - If isFading: use even dimmer '#1e1e00' (halfway to normal)
   - Otherwise: undefined (default)
3. Apply backgroundColor to the main row Box

Example:
```tsx
const highlightBg = isHighlighted
  ? (isFading ? '#1e1e00' : '#3d3d00')
  : undefined;

return (
  <Box flexDirection="column">
    <Box backgroundColor={highlightBg} ...>
```

Changes to TodoItem.tsx:
1. Check current TodoItemProps interface
2. Add `isHighlighted?: boolean` and `isFading?: boolean`
3. Apply same background color logic to the todo row Box

Use same colors for consistency: '#3d3d00' (highlight) and '#1e1e00' (fading).
  </action>
  <verify>
TypeScript compiles: `bunx tsc --noEmit`
PhaseRow accepts isHighlighted and isFading props
TodoItem accepts isHighlighted and isFading props
  </verify>
  <done>
PhaseRow and TodoItem show yellow background when isHighlighted is true, dimmer when isFading.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire file watcher and highlights in App.tsx</name>
  <files>src/app.tsx</files>
  <action>
Connect useFileWatcher, useChangeHighlight, and useGsdData in App.tsx.

Implementation steps:

1. Import the new hooks:
```tsx
import { useFileWatcher } from './hooks/useFileWatcher.ts';
import { useChangeHighlight } from './hooks/useChangeHighlight.ts';
```

2. In App component, add file watcher:
```tsx
const planningDir = flags.dir ?? '.planning';

const { changedFiles, isRefreshing, lastRefresh } = useFileWatcher({
  path: planningDir,
  debounceMs: 300,
  onError: (err) => console.error('File watcher error:', err),
});
```

3. Connect to data loading:
```tsx
const data = useGsdData(planningDir, lastRefresh ?? undefined, changedFiles);
```

4. Add change highlight tracking:
```tsx
const { markChanged, isHighlighted, isFading } = useChangeHighlight({
  holdDurationMs: 5000,
  fadeDurationMs: 500,
});
```

5. Use useEffect to mark items as changed when changedFiles updates:
```tsx
useEffect(() => {
  if (changedFiles.length > 0) {
    // Derive item IDs from changed files
    // E.g., ROADMAP.md -> mark all phases
    // E.g., phases/01-*/01-*-PLAN.md -> mark phase 1
    // E.g., todos/*.md or STATE.md -> mark affected todos
    const itemIds = deriveAffectedItemIds(changedFiles, data);
    markChanged(itemIds);
  }
}, [changedFiles, data, markChanged]);
```

6. Create helper function deriveAffectedItemIds:
```tsx
function deriveAffectedItemIds(files: string[], data: GsdData): string[] {
  const ids: string[] = [];

  for (const file of files) {
    // ROADMAP.md affects all phases
    if (file.includes('ROADMAP.md')) {
      data.phases.forEach(p => ids.push(`phase-${p.number}`));
    }
    // Phase-specific files affect that phase
    // Match patterns like "phases/01-xxx/" or "phases/1-xxx/"
    const phaseMatch = file.match(/phases\/(\d+)-/);
    if (phaseMatch) {
      ids.push(`phase-${parseInt(phaseMatch[1], 10)}`);
    }
    // STATE.md or todos/*.md affects todos
    if (file.includes('STATE.md') || file.includes('todos/')) {
      data.todos.forEach(t => ids.push(`todo-${t.id}`));
    }
  }

  return [...new Set(ids)]; // Dedupe
}
```

7. Pass isRefreshing to Header:
```tsx
<Header projectName={data.state.projectName} state={data.state} isRefreshing={isRefreshing} />
```

8. Pass highlight functions to TabLayout (which passes to views):
```tsx
<TabLayout
  data={data}
  flags={flags}
  isActive={!showHelp}
  onTabChange={setActiveTab}
  isPhaseHighlighted={(num) => isHighlighted(`phase-${num}`)}
  isPhaseFading={(num) => isFading(`phase-${num}`)}
  isTodoHighlighted={(id) => isHighlighted(`todo-${id}`)}
  isTodoFading={(id) => isFading(`todo-${id}`)}
/>
```

9. Update TabLayout, RoadmapView, TodosView to pass highlight props down to PhaseRow and TodoItem.

This involves updating:
- TabLayout.tsx props interface
- RoadmapView.tsx to accept and use isPhaseHighlighted/isPhaseFading
- TodosView.tsx to accept and use isTodoHighlighted/isTodoFading
- Pass the highlight check result to each PhaseRow and TodoItem
  </action>
  <verify>
`bun run dev` starts without errors
Make a change to .planning/ROADMAP.md and observe:
1. Spinner appears briefly in header
2. Phase rows show yellow highlight
3. Highlight fades after ~5 seconds
  </verify>
  <done>
TUI automatically refreshes when .planning/ files change, shows spinner during refresh, and highlights changed items for 5 seconds.
  </done>
</task>

</tasks>

<verification>
Manual testing:
1. `bun run dev` - TUI starts normally
2. In another terminal: `echo "" >> .planning/ROADMAP.md`
3. Observe: Spinner appears briefly, phases highlight yellow
4. Wait 5+ seconds: Highlight fades to normal

Test rapid saves:
1. Run: `for i in 1 2 3; do echo "" >> .planning/STATE.md; sleep 0.1; done`
2. Observe: Single refresh after rapid changes (debounced), no flicker

Test edge cases:
1. Delete a todo file while TUI is running - should handle gracefully
2. Create a new file in .planning/ - should trigger refresh
</verification>

<success_criteria>
- [ ] Header shows spinner during file refresh (RT-02 partial)
- [ ] PhaseRow shows highlight for changed phases (RT-03)
- [ ] TodoItem shows highlight for changed todos (RT-03)
- [ ] Highlights fade after 5 seconds (RT-03)
- [ ] File watcher triggers data reload (RT-01)
- [ ] Rapid saves are debounced - no flicker (RT-02)
- [ ] Navigation state preserved across refreshes
- [ ] All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-real-time-updates/02-02-SUMMARY.md`
</output>
